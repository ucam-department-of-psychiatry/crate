
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crate_anon.crateweb.research.views &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crate_anon.crateweb.research.views</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># crate_anon/crateweb/research/views.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>
<span class="sd">    Copyright (C) 2015-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CRATE.</span>

<span class="sd">    CRATE is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CRATE is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CRATE. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="sd">===============================================================================</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="c1"># from functools import lru_cache</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="c1"># import pprint</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.dbfunc</span> <span class="k">import</span> <span class="n">get_fieldnames_from_cursor</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.django.function_cache</span> <span class="k">import</span> <span class="n">django_cache_function</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.django.serve</span> <span class="k">import</span> <span class="n">file_response</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.exceptions</span> <span class="k">import</span> <span class="n">recover_info_from_exception</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.hash</span> <span class="k">import</span> <span class="n">hash64</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.logs</span> <span class="k">import</span> <span class="n">BraceStyleAdapter</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.dialect</span> <span class="k">import</span> <span class="n">SqlaDialectName</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="k">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="k">import</span> <span class="n">user_passes_test</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ObjectDoesNotExist</span><span class="p">,</span>
    <span class="n">ValidationError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="k">import</span> <span class="n">reverse</span>
<span class="c1"># from django.db import connection</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">DatabaseError</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Q</span><span class="p">,</span> <span class="n">QuerySet</span>
<span class="kn">from</span> <span class="nn">django.http.response</span> <span class="k">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.http.request</span> <span class="k">import</span> <span class="n">HttpRequest</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="k">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="k">import</span> <span class="n">escape</span>
<span class="kn">from</span> <span class="nn">pyparsing</span> <span class="k">import</span> <span class="n">ParseException</span>

<span class="kn">from</span> <span class="nn">crate_anon.common.contenttypes</span> <span class="k">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">crate_anon.common.sql</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ColumnId</span><span class="p">,</span>
    <span class="n">escape_sql_string_literal</span><span class="p">,</span>
    <span class="n">escape_sql_string_or_int_literal</span><span class="p">,</span>
    <span class="n">SQL_OPS_MULTIPLE_VALUES</span><span class="p">,</span>
    <span class="n">SQL_OPS_VALUE_UNNECESSARY</span><span class="p">,</span>
    <span class="n">TableId</span><span class="p">,</span>
    <span class="n">toggle_distinct</span><span class="p">,</span>
    <span class="n">WhereCondition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.core.utils</span> <span class="k">import</span> <span class="n">is_clinician</span><span class="p">,</span> <span class="n">is_superuser</span><span class="p">,</span> <span class="n">paginate</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.research.forms</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">AddHighlightForm</span><span class="p">,</span>
    <span class="n">AddQueryForm</span><span class="p">,</span>
    <span class="n">ClinicianAllTextFromPidForm</span><span class="p">,</span>
    <span class="n">DatabasePickerForm</span><span class="p">,</span>
    <span class="n">DEFAULT_MIN_TEXT_FIELD_LENGTH</span><span class="p">,</span>
    <span class="n">FieldPickerInfo</span><span class="p">,</span>
    <span class="n">ManualPeQueryForm</span><span class="p">,</span>
    <span class="n">PidLookupForm</span><span class="p">,</span>
    <span class="n">QueryBuilderForm</span><span class="p">,</span>
    <span class="n">RidLookupForm</span><span class="p">,</span>
    <span class="n">SQLHelperTextAnywhereForm</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.research.html_functions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">highlight_text</span><span class="p">,</span>
    <span class="n">HtmlElementCounter</span><span class="p">,</span>
    <span class="n">make_result_element</span><span class="p">,</span>
    <span class="n">make_collapsible_sql_query</span><span class="p">,</span>
    <span class="n">N_CSS_HIGHLIGHT_CLASSES</span><span class="p">,</span>
    <span class="n">prettify_sql_css</span><span class="p">,</span>
    <span class="n">prettify_sql_html</span><span class="p">,</span>
    <span class="n">prettify_sql_and_args</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.research.models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Highlight</span><span class="p">,</span>
    <span class="n">PidLookup</span><span class="p">,</span>
    <span class="n">PatientExplorer</span><span class="p">,</span>
    <span class="n">PatientMultiQuery</span><span class="p">,</span>
    <span class="n">Query</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.research.research_db_info</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">research_database_info</span><span class="p">,</span>
    <span class="n">PatientFieldPythonTypes</span><span class="p">,</span>
    <span class="n">SingleResearchDatabase</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.userprofile.models</span> <span class="k">import</span> <span class="n">get_patients_per_page</span>
<span class="kn">from</span> <span class="nn">crate_anon.crateweb.research.sql_writer</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">add_to_select</span><span class="p">,</span>
    <span class="n">SelectElement</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">BraceStyleAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Helper functions</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="validate_blank_form"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.validate_blank_form">[docs]</a><span class="k">def</span> <span class="nf">validate_blank_form</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks that the request is (a) a POST request, and (b) passes CRSF</span>
<span class="sd">    validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Use HTTP POST, not HTTP GET or other methods&quot;</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>  <span class="c1"># checks CSRF</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Form failed validation&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">query_id</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">get_active_query_id_or_none</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">pe_id</span> <span class="o">=</span> <span class="n">PatientExplorer</span><span class="o">.</span><span class="n">get_active_pe_id_or_none</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;query_selected&#39;</span><span class="p">:</span> <span class="n">query_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;current_query_id&#39;</span><span class="p">:</span> <span class="n">query_id</span><span class="p">,</span>
        <span class="s1">&#39;pe_selected&#39;</span><span class="p">:</span> <span class="n">pe_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;current_pe_id&#39;</span><span class="p">:</span> <span class="n">pe_id</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Try to minimize SQL here, as these calls will be used for EVERY</span>
    <span class="c1"># request.</span>
    <span class="c1"># This problem can be circumvented with a per-request cache; see</span>
    <span class="c1"># http://stackoverflow.com/questions/3151469/per-request-cache-in-django</span>


<span class="k">def</span> <span class="nf">datetime_iso_for_filename</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">dtnow</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dtnow</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Errors</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">generic_error</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;generic_error.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Queries</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@django_cache_function</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># @lru_cache(maxsize=None)</span>
<span class="k">def</span> <span class="nf">get_db_structure_json</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">colinfolist</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_colinfolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">colinfolist</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;get_db_structure_json(): colinfolist is empty&quot;</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Dict[str, Any]]</span>
    <span class="k">for</span> <span class="n">dbinfo</span> <span class="ow">in</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">dbinfolist</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;get_db_structure_json: schema </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">dbinfo</span><span class="o">.</span><span class="n">schema_identifier</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">eligible_for_query_builder</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping schema=</span><span class="si">{}</span><span class="s2">: not eligible for query &quot;</span>
                      <span class="s2">&quot;builder&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">schema_identifier</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">schema_cil</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">colinfolist</span>
                      <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">table_catalog</span> <span class="o">==</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">database</span> <span class="ow">and</span>
                      <span class="n">x</span><span class="o">.</span><span class="n">table_schema</span> <span class="o">==</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">schema_name</span><span class="p">]</span>
        <span class="n">table_info</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Dict[str, Any]]</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">table_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">schema_cil</span><span class="p">)):</span>
            <span class="n">table_cil</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">schema_cil</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">table_name</span> <span class="o">==</span> <span class="n">table</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">table_cil</span>
                       <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">column_name</span> <span class="o">==</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">trid_field</span><span class="p">):</span>
                <span class="c1"># This table doesn&#39;t contain a TRID, so we will skip it.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;... skipping table </span><span class="si">{}</span><span class="s2">: no TRID [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">table</span><span class="p">,</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">trid_field</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">table_cil</span>
                       <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">column_name</span> <span class="o">==</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_field</span><span class="p">):</span>
                <span class="c1"># This table doesn&#39;t contain a RID, so we will skip it.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;... skipping table </span><span class="si">{}</span><span class="s2">: no RID [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">table</span><span class="p">,</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_field</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">column_info</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Dict[str, str]]</span>
            <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">table_cil</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">column_name</span><span class="p">):</span>
                <span class="n">column_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;colname&#39;</span><span class="p">:</span> <span class="n">ci</span><span class="o">.</span><span class="n">column_name</span><span class="p">,</span>
                    <span class="s1">&#39;coltype&#39;</span><span class="p">:</span> <span class="n">ci</span><span class="o">.</span><span class="n">querybuilder_type</span><span class="p">,</span>
                    <span class="s1">&#39;rawtype&#39;</span><span class="p">:</span> <span class="n">ci</span><span class="o">.</span><span class="n">column_type</span><span class="p">,</span>
                    <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">ci</span><span class="o">.</span><span class="n">column_comment</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="p">})</span>
            <span class="k">if</span> <span class="n">column_info</span><span class="p">:</span>
                <span class="n">table_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
                    <span class="s1">&#39;columns&#39;</span><span class="p">:</span> <span class="n">column_info</span><span class="p">,</span>
                <span class="p">})</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;... using table </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> columns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">table</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_info</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">table_info</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
                <span class="s1">&#39;schema&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">schema_name</span><span class="p">,</span>
                <span class="s1">&#39;tables&#39;</span><span class="p">:</span> <span class="n">table_info</span><span class="p">,</span>
            <span class="p">})</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>


<div class="viewcode-block" id="query_build"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.query_build">[docs]</a><span class="k">def</span> <span class="nf">query_build</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assisted query builder, based on the data dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTES FOR FIRST METHOD, with lots (and lots) of forms.</span>
    <span class="c1"># - In what follows, we want a normal template but we want to include a</span>
    <span class="c1">#   large chunk of raw HTML. I was doing this with</span>
    <span class="c1">#   {{ builder_html | safe }} within the template, but it was very slow</span>
    <span class="c1">#   (e.g. 500ms on my machine; 50s on the CPFT &quot;sandpit&quot; server,</span>
    <span class="c1">#   2016-06-28). The delay was genuinely in the template rendering, it</span>
    <span class="c1">#   seems, based on profiling and manual log calls.</span>
    <span class="c1"># - A simple string replacement, as below, was about 7% of the total time</span>
    <span class="c1">#   (e.g. 3300ms instead of 50s).</span>
    <span class="c1"># - Other alternatives might include the Jinja2 template system, which is</span>
    <span class="c1">#   apparently faster than the Django default, but we may not need further</span>
    <span class="c1">#   optimization.</span>
    <span class="c1"># - Another, potentially better, solution, is not to send dozens or</span>
    <span class="c1">#   hundreds of forms, but to write some Javascript to make this happen</span>
    <span class="c1">#   mostly on the client side. Might look better, too. (Yes, it does.)</span>

    <span class="c1"># NB: first &quot;submit&quot; button takes the Enter key, so place WHERE</span>
    <span class="c1"># before SELECT so users can hit enter in the WHERE value fields.</span>

    <span class="c1"># - If you provide the &quot;request=request&quot; argument to</span>
    <span class="c1">#   render_to_string it gives you the CSRF token.</span>
    <span class="c1"># - Another way is to ignore &quot;request&quot; and use render_to_string</span>
    <span class="c1">#   with a manually crafted context including &#39;csrf_token&#39;.</span>
    <span class="c1">#   (This avoids the global context processors.)</span>
    <span class="c1"># - Note that the CSRF token prevents simple caching of the forms.</span>
    <span class="c1"># - But we can&#39;t cache anyway if we&#39;re going to have some forms</span>
    <span class="c1">#   (differentially) non-collapsed at the start, e.g. on form POST.</span>
    <span class="c1"># - Also harder work to do this HTML manually (rather than with</span>
    <span class="c1">#   template rendering), because the csrf_token ends up like:</span>
    <span class="c1">#   &lt;input type=&#39;hidden&#39; name=&#39;csrfmiddlewaretoken&#39; value=&#39;RGN5UZnTVkLFAVNtXRpJwn5CclBRAdLr&#39; /&gt;  # noqa</span>

    <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">parse_error</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">default_database</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_database_name</span><span class="p">()</span>
    <span class="n">default_schema</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_schema_name</span><span class="p">()</span>
    <span class="n">with_database</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">uses_database_level</span><span class="p">()</span>
    <span class="n">form</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">grammar</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">grammar</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;global_clear&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="k">elif</span> <span class="s1">&#39;global_toggle_distinct&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span> <span class="o">=</span> <span class="n">toggle_distinct</span><span class="p">(</span>
                    <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span><span class="p">,</span> <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">)</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="k">elif</span> <span class="s1">&#39;global_save&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">query_submit</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">elif</span> <span class="s1">&#39;global_run&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">query_submit</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">QueryBuilderForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                    <span class="n">database</span> <span class="o">=</span> <span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">with_database</span>
                                <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">schema</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">]</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span>
                    <span class="n">column_id</span> <span class="o">=</span> <span class="n">ColumnId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                                         <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>
                    <span class="n">table_id</span> <span class="o">=</span> <span class="n">column_id</span><span class="o">.</span><span class="n">table_id</span>

                    <span class="k">if</span> <span class="s1">&#39;submit_select&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                        <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span> <span class="o">=</span> <span class="n">add_to_select</span><span class="p">(</span>
                            <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span><span class="p">,</span>
                            <span class="n">select_elements</span><span class="o">=</span><span class="p">[</span>
                                <span class="n">SelectElement</span><span class="p">(</span><span class="n">column_id</span><span class="o">=</span><span class="n">column_id</span><span class="p">)</span>
                            <span class="p">],</span>
                            <span class="n">magic_join</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span>
                        <span class="p">)</span>

                    <span class="k">elif</span> <span class="s1">&#39;submit_select_star&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                        <span class="n">select_elements</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">SelectElement</span><span class="p">(</span><span class="n">column_id</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">column_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>
                            <span class="n">research_database_info</span><span class="o">.</span><span class="n">all_columns</span><span class="p">(</span><span class="n">table_id</span><span class="p">)]</span>
                        <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span> <span class="o">=</span> <span class="n">add_to_select</span><span class="p">(</span>
                            <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span><span class="p">,</span>
                            <span class="n">select_elements</span><span class="o">=</span><span class="n">select_elements</span><span class="p">,</span>
                            <span class="n">magic_join</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="k">elif</span> <span class="s1">&#39;submit_where&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                        <span class="n">datatype</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span>
                        <span class="n">op</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;where_op&#39;</span><span class="p">]</span>
                        <span class="c1"># Value</span>
                        <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">SQL_OPS_MULTIPLE_VALUES</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">file_values_list</span>
                        <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">SQL_OPS_VALUE_UNNECESSARY</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get_cleaned_where_value</span><span class="p">()</span>
                        <span class="c1"># WHERE fragment</span>
                        <span class="n">wherecond</span> <span class="o">=</span> <span class="n">WhereCondition</span><span class="p">(</span><span class="n">column_id</span><span class="o">=</span><span class="n">column_id</span><span class="p">,</span>
                                                   <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span>
                                                   <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span>
                                                   <span class="n">value_or_values</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span> <span class="o">=</span> <span class="n">add_to_select</span><span class="p">(</span>
                            <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span><span class="p">,</span>
                            <span class="n">where_type</span><span class="o">=</span><span class="s2">&quot;AND&quot;</span><span class="p">,</span>
                            <span class="n">where_conditions</span><span class="o">=</span><span class="p">[</span><span class="n">wherecond</span><span class="p">],</span>
                            <span class="n">magic_join</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad form command!&quot;</span><span class="p">)</span>
                    <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">except</span> <span class="n">ParseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">parse_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">form</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">QueryBuilderForm</span><span class="p">()</span>

    <span class="n">starting_values_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">with_database</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;schema&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;where_op&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;date_value&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date_value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="c1"># Impossible to set file_value programmatically. (See querybuilder.js.)</span>
        <span class="s1">&#39;float_value&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;float_value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;int_value&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;int_value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;string_value&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;string_value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;offer_where&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span><span class="p">),</span>  <span class="c1"># existing SELECT?</span>
        <span class="s1">&#39;form_errors&#39;</span><span class="p">:</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
        <span class="s1">&#39;default_database&#39;</span><span class="p">:</span> <span class="n">default_database</span><span class="p">,</span>
        <span class="s1">&#39;default_schema&#39;</span><span class="p">:</span> <span class="n">default_schema</span><span class="p">,</span>
        <span class="s1">&#39;with_database&#39;</span><span class="p">:</span> <span class="n">with_database</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;nav_on_querybuilder&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="n">prettify_sql_html</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span><span class="p">),</span>
        <span class="s1">&#39;parse_error&#39;</span><span class="p">:</span> <span class="n">parse_error</span><span class="p">,</span>
        <span class="s1">&#39;database_structure&#39;</span><span class="p">:</span> <span class="n">get_db_structure_json</span><span class="p">(),</span>
        <span class="s1">&#39;starting_values&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">starting_values_dict</span><span class="p">),</span>
        <span class="s1">&#39;sql_dialect&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_DIALECT</span><span class="p">,</span>
        <span class="s1">&#39;dialect_mysql&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_DIALECT</span> <span class="o">==</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MYSQL</span><span class="p">,</span>
        <span class="s1">&#39;dialect_mssql&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_DIALECT</span> <span class="o">==</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">,</span>
        <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;query_build.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">get_all_queries</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Query</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">deleted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-active&#39;</span><span class="p">,</span> <span class="s1">&#39;-created&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_identical_queries</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Query</span><span class="p">]:</span>
    <span class="n">all_queries</span> <span class="o">=</span> <span class="n">get_all_queries</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c1"># identical_queries = all_queries.filter(sql=sql)</span>
    <span class="c1">#</span>
    <span class="c1"># - 2017-02-03: we had a problem here, in which the parameter was sent to</span>
    <span class="c1">#   SQL Server as type NTEXT, but the field &quot;sql&quot; is NVARCHAR(MAX), leading</span>
    <span class="c1">#   to &quot;The data types nvarchar(max) and ntext are incompatible in the</span>
    <span class="c1">#   equal to operator.&quot;</span>
    <span class="c1"># - The Django field type TextField is converted to NVARCHAR(MAX) by</span>
    <span class="c1">#   django-pyodbc-azure, in sql_server/pyodbc/base.py, also at [1].</span>
    <span class="c1"># - That seems fine; NVARCHAR(MAX) seems more capable than NTEXT.</span>
    <span class="c1">#   NTEXT is deprecated.</span>
    <span class="c1"># - Error is reproducible with</span>
    <span class="c1">#       ... WHERE sql = CAST(&#39;hello&#39; AS NTEXT) ...</span>
    <span class="c1"># - The order of the types in the error message matches the order in the</span>
    <span class="c1">#   SQL statement.</span>
    <span class="c1"># - A solution would be to cast the parameter as</span>
    <span class="c1">#   CAST(some_parameter AS NVARCHAR(MAX))</span>
    <span class="c1"># - Fixed by upgrading pyodbc from 3.1.1 to 4.0.3</span>
    <span class="c1"># - Added to FAQ</span>
    <span class="c1"># - WARNING: the problem came back with pyodbc==4.0.6, but not fixed again</span>
    <span class="c1">#   by downgrading to 4.0.3</span>
    <span class="c1"># - See also [2].</span>
    <span class="c1"># - An alternative solution would not be to compare on the long text, but</span>
    <span class="c1">#   store and compare on a hash of it.</span>
    <span class="c1"># - The problem is that either pyodbc or ODBC itself, somehow, is sending</span>
    <span class="c1">#   the string parameter as NTEXT.</span>
    <span class="c1">#   Similar Perl problem: [3].</span>
    <span class="c1">#</span>
    <span class="c1"># - In pyodbc, the key functions are:</span>
    <span class="c1">#       cursor.cpp: static PyObject* execute(...)</span>
    <span class="c1">#       -&gt; params.cpp: bool PrepareAndBind(...)</span>
    <span class="c1">#           -&gt; GetParameterInfo  // THIS ONE</span>
    <span class="c1">#               Parameter will be of type str.</span>
    <span class="c1">#               This will fail for PyBytes_Check [4].</span>
    <span class="c1">#               This will match for PyUnicode_Check [5].</span>
    <span class="c1">#               Thus:</span>
    <span class="c1">#                   -&gt; GetUnicodeInfo</span>
    <span class="c1">#                   ... and depending on the string length of the</span>
    <span class="c1">#                       parameter, this returns either</span>
    <span class="c1">#                   SQL_WVARCHAR -&gt; NVARCHAR on SQL Server [6], for short strings  # noqa</span>
    <span class="c1">#                   SQL_WLONGVARCHAR -&gt; NTEXT on SQL Server [6], for long strings  # noqa</span>
    <span class="c1">#                   ... and the length depends on</span>
    <span class="c1">#                       -&gt; connection.h: cur-&gt;cnxn-&gt;GetMaxLength(info.ValueType);  # noqa</span>
    <span class="c1">#           -&gt; BindParameter</span>
    <span class="c1">#   in cursor.cpp</span>
    <span class="c1">#</span>
    <span class="c1"># - Now we also have pyodbc docs: [7].</span>
    <span class="c1">#</span>
    <span class="c1"># - Anyway, the upshot is that there is some unpredictabilty in sending</span>
    <span class="c1">#   very long parameters... the intermittency would be explained by some</span>
    <span class="c1">#   dependency on string length.</span>
    <span class="c1"># - Empirically, it fails somewhere around 1,900 characters.</span>
    <span class="c1">#</span>
    <span class="c1"># - Could switch away from pyodbc, e.g. to Django-mssql [8, 9].</span>
    <span class="c1">#   But, as per the CRATE manual, there were version incompatibilities</span>
    <span class="c1">#   here. Tried again with v1.8, but it gave configuration errors</span>
    <span class="c1">#   (ADODB.Connection; Provider cannot be found. It may not be properly</span>
    <span class="c1">#   installed.) Anyway, pyodbc is good enough for SQLAlchemy.</span>
    <span class="c1">#</span>
    <span class="c1"># [1] https://github.com/michiya/django-pyodbc-azure/blob/azure-1.10/sql_server/pyodbc/base.py  # noqa</span>
    <span class="c1"># [2] https://github.com/mkleehammer/pyodbc/blob/master/tests2/informixtests.py  # noqa</span>
    <span class="c1"># [3] http://stackoverflow.com/questions/13090907</span>
    <span class="c1"># [4] https://docs.python.org/3/c-api/bytes.html</span>
    <span class="c1"># [5] https://docs.python.org/3/c-api/unicode.html</span>
    <span class="c1"># [6] https://documentation.progress.com/output/DataDirect/DataDirectCloud/index.html#page/queries/microsoft-sql-server-data-types.html  # noqa</span>
    <span class="c1"># [7] https://github.com/mkleehammer/pyodbc/wiki/Data-Types</span>
    <span class="c1"># [8] https://docs.djangoproject.com/en/1.10/ref/databases/#using-a-3rd-party-database-backend  # noqa</span>
    <span class="c1"># [9] https://django-mssql.readthedocs.io/en/latest/</span>

    <span class="c1"># Screw it, let&#39;s use a hash. We can use our hash64() function and</span>
    <span class="c1"># a Django BigIntegerField.</span>

    <span class="n">identical_queries</span> <span class="o">=</span> <span class="n">all_queries</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sql_hash</span><span class="o">=</span><span class="n">hash64</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
    <span class="c1"># Now eliminate any chance of errors via hash collisions by double-checking</span>
    <span class="c1"># the Python objects:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">q</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">identical_queries</span> <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">sql</span> <span class="o">==</span> <span class="n">sql</span><span class="p">]</span>


<div class="viewcode-block" id="query_submit"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.query_submit">[docs]</a><span class="k">def</span> <span class="nf">query_submit</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                 <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ancillary function to add a query, and redirect to the editing or</span>
<span class="sd">    run page.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">identical_queries</span> <span class="o">=</span> <span class="n">get_identical_queries</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">identical_queries</span><span class="p">:</span>
        <span class="n">identical_queries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="n">query_id</span> <span class="o">=</span> <span class="n">identical_queries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                      <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">query_id</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">id</span>
    <span class="c1"># redirect to a new URL:</span>
    <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="n">query_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="query_edit_select"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.query_edit_select">[docs]</a><span class="k">def</span> <span class="nf">query_edit_select</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Edit or select SQL for current query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># log.debug(&quot;query&quot;)</span>
    <span class="c1"># if this is a POST request we need to process the form data</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># create a form instance and populate it with data from the request:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AddQueryForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="c1"># check whether it&#39;s valid:</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">cmd_run</span> <span class="o">=</span> <span class="s1">&#39;submit_run&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span>
            <span class="n">cmd_add</span> <span class="o">=</span> <span class="s1">&#39;submit_add&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span>
            <span class="n">cmd_builder</span> <span class="o">=</span> <span class="s1">&#39;submit_builder&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span>
            <span class="c1"># process the data in form.cleaned_data as required</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;sql&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cmd_add</span> <span class="ow">or</span> <span class="n">cmd_run</span><span class="p">:</span>
                <span class="n">run</span> <span class="o">=</span> <span class="s1">&#39;submit_run&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span>
                <span class="k">return</span> <span class="n">query_submit</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">run</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cmd_builder</span><span class="p">:</span>
                <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">sql_scratchpad</span> <span class="o">=</span> <span class="n">sql</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;build_query&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad command!&quot;</span><span class="p">)</span>

    <span class="c1"># if a GET (or any other method) we&#39;ll create a blank form</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">all_queries</span> <span class="o">=</span> <span class="n">get_all_queries</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">active_queries</span> <span class="o">=</span> <span class="n">all_queries</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">active_queries</span><span class="p">:</span>
        <span class="n">values</span><span class="p">[</span><span class="s1">&#39;sql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">active_queries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_original_sql</span><span class="p">()</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">AddQueryForm</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">queries</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">all_queries</span><span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">element_counter</span> <span class="o">=</span> <span class="n">HtmlElementCounter</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
        <span class="n">q</span><span class="o">.</span><span class="n">formatted_query_safe</span> <span class="o">=</span> <span class="n">make_collapsible_sql_query</span><span class="p">(</span>
            <span class="n">q</span><span class="o">.</span><span class="n">get_original_sql</span><span class="p">(),</span>
            <span class="n">element_counter</span><span class="o">=</span><span class="n">element_counter</span><span class="p">,</span>
            <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;queries&#39;</span><span class="p">:</span> <span class="n">queries</span><span class="p">,</span>
        <span class="s1">&#39;nav_on_query&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;dialect_mysql&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_DIALECT</span> <span class="o">==</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MYSQL</span><span class="p">,</span>
        <span class="s1">&#39;dialect_mssql&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_DIALECT</span> <span class="o">==</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">,</span>
        <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;query_edit_select.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">query_activate</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">validate_blank_form</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">query_id</span><span class="p">)</span>  <span class="c1"># type: Query</span>
    <span class="n">query</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">query_delete</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">validate_blank_form</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">query_id</span><span class="p">)</span>  <span class="c1"># type: Query</span>
    <span class="n">query</span><span class="o">.</span><span class="n">delete_if_permitted</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">no_query_selected</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;query_none_selected.html&#39;</span><span class="p">,</span> <span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>


<div class="viewcode-block" id="query_count"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.query_count">[docs]</a><span class="k">def</span> <span class="nf">query_count</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View COUNT(*) from specific query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">query_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">no_query_selected</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">query_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_id</span><span class="p">)</span>
        <span class="c1"># ... conceivably might raise TypeError (from e.g. None), ValueError</span>
        <span class="c1"># (from e.g. &quot;xyz&quot;), but both should be filtered out by the URL parser</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">query_id</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="c1"># ... will return None if not found, but may raise something derived</span>
        <span class="c1"># from ObjectDoesNotExist or (in principle, if this weren&#39;t a PK)</span>
        <span class="c1"># MultipleObjectsReturned;</span>
        <span class="c1"># https://docs.djangoproject.com/en/1.9/ref/models/querysets/#django.db.models.query.QuerySet.get  # noqa</span>
    <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_query_id</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_resultcount</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="query_count_current"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.query_count_current">[docs]</a><span class="k">def</span> <span class="nf">query_count_current</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View COUNT(*) from current query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">get_active_query_or_none</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">no_query_selected</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_resultcount</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="query_results"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.query_results">[docs]</a><span class="k">def</span> <span class="nf">query_results</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View results of chosen query, in tabular format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">query_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">no_query_selected</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">query_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_id</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">query_id</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_query_id</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query_id</span><span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">highlights</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">get_active_highlights</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_resultset</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">highlights</span><span class="p">,</span>
                            <span class="n">collapse_at_len</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_len</span><span class="p">,</span>
                            <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
                            <span class="n">line_length</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">line_length</span><span class="p">)</span></div>


<div class="viewcode-block" id="query_results_recordwise"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.query_results_recordwise">[docs]</a><span class="k">def</span> <span class="nf">query_results_recordwise</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                             <span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View results of chosen query, in tabular format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">query_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">no_query_selected</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">query_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_id</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">query_id</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_query_id</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query_id</span><span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">highlights</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">get_active_highlights</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_resultset_recordwise</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">highlights</span><span class="p">,</span>
        <span class="n">collapse_at_len</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_len</span><span class="p">,</span>
        <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
        <span class="n">line_length</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">line_length</span><span class="p">)</span></div>


<div class="viewcode-block" id="query_tsv"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.query_tsv">[docs]</a><span class="k">def</span> <span class="nf">query_tsv</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download TSV of current query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">query_id</span><span class="p">)</span>  <span class="c1"># type: Query</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">file_response</span><span class="p">(</span>
            <span class="n">query</span><span class="o">.</span><span class="n">make_tsv</span><span class="p">(),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TSV</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;crate_results_</span><span class="si">{num}</span><span class="s2">_</span><span class="si">{datetime}</span><span class="s2">.tsv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">num</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">datetime</span><span class="o">=</span><span class="n">datetime_iso_for_filename</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_query</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">query_excel</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">query_id</span><span class="p">)</span>  <span class="c1"># type: Query</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">file_response</span><span class="p">(</span>
            <span class="n">query</span><span class="o">.</span><span class="n">make_excel</span><span class="p">(),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">XLSX</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;crate_query_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.xlsx&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">query_id</span><span class="p">,</span> <span class="n">datetime_iso_for_filename</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_query</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>


<span class="c1"># @user_passes_test(is_superuser)</span>
<span class="c1"># def audit(request):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     View audit log</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     all_audits = QueryAudit.objects.all()\</span>
<span class="c1">#                                    .select_related(&#39;query&#39;, &#39;query__user&#39;)\</span>
<span class="c1">#                                    .order_by(&#39;-id&#39;)</span>
<span class="c1">#     audits = paginate(request, all_audits)</span>
<span class="c1">#     context = {&#39;audits&#39;: audits}</span>
<span class="c1">#     return render(request, &#39;audit.html&#39;, context)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Internal functions for views on queries</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># def make_demo_query_unless_exists(request):</span>
<span class="c1">#     DEMOQUERY = Query(</span>
<span class="c1">#         pk=1,</span>
<span class="c1">#         sql=&quot;SELECT * FROM notes\nWHERE note LIKE &#39;%Adam%&#39;\nLIMIT 20&quot;,</span>
<span class="c1">#         raw=True,</span>
<span class="c1">#         user=request.user,</span>
<span class="c1">#     )</span>
<span class="c1">#     DEMOQUERY.save()</span>
<span class="c1">#     H1 = Highlight(pk=1, text=&quot;Aaron&quot;, colour=0, user=request.user)</span>
<span class="c1">#     H1.save()</span>
<span class="c1">#     H2 = Highlight(pk=2, text=&quot;Adam&quot;, colour=0, user=request.user)</span>
<span class="c1">#     H2.save()</span>
<span class="c1">#     H3 = Highlight(pk=3, text=&quot;October&quot;, colour=1, user=request.user)</span>
<span class="c1">#     H3.save()</span>

<span class="c1"># EXCEPTIONS FOR HOMEBREW SQL.</span>
<span class="c1"># You can see:</span>
<span class="c1"># - django.db.ProgrammingError</span>
<span class="c1"># - django.db.OperationalError</span>
<span class="c1"># - InternalError (?django.db.utils.InternalError)</span>
<span class="c1"># ... but I think all are subclasses of django.db.utils.DatabaseError</span>


<div class="viewcode-block" id="render_resultcount"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.render_resultcount">[docs]</a><span class="k">def</span> <span class="nf">render_resultcount</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays the number of rows that a given query will fetch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_missing_query</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">query</span><span class="o">.</span><span class="n">get_executed_cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">rowcount</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
        <span class="n">query</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">count_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_records</span><span class="o">=</span><span class="n">rowcount</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;rowcount&#39;</span><span class="p">:</span> <span class="n">rowcount</span><span class="p">,</span>
            <span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="n">query</span><span class="o">.</span><span class="n">get_original_sql</span><span class="p">(),</span>
            <span class="s1">&#39;nav_on_count&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;query_count.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="c1"># See above re exception classes</span>
    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">query</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">count_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">failed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">fail_msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render_bad_query</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">resultset_html_table</span><span class="p">(</span><span class="n">fieldnames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                         <span class="n">rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
                         <span class="n">element_counter</span><span class="p">:</span> <span class="n">HtmlElementCounter</span><span class="p">,</span>
                         <span class="n">start_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="n">highlight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Highlight</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">collapse_at_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">collapse_at_n_lines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">line_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">ditto</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">ditto_html</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                         <span class="n">no_ditto_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">null</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&lt;i&gt;NULL&lt;/i&gt;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># Considered but not implemented: hiding table columns</span>
    <span class="c1"># ... see esp &quot;tr &gt; *:nth-child(n)&quot; at</span>
    <span class="c1"># http://stackoverflow.com/questions/5440657/how-to-hide-columns-in-html-table  # noqa</span>
    <span class="n">no_ditto_cols</span> <span class="o">=</span> <span class="n">no_ditto_cols</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">ditto_cell</span> <span class="o">=</span> <span class="s1">&#39;    &lt;td class=&quot;queryresult ditto&quot;&gt;</span><span class="si">{}</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">ditto_html</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;table&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;  &lt;tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;    &lt;th&gt;&lt;i&gt;#&lt;/i&gt;&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;    &lt;th&gt;</span><span class="si">{}</span><span class="s1">&lt;/th&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;  &lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">row_index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
        <span class="c1"># row_index is zero-based within this table</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;  &lt;tr class=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;stripy_even&quot;</span> <span class="k">if</span> <span class="n">row_index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;stripy_odd&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Row number</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;    &lt;td&gt;&lt;b&gt;&lt;i&gt;</span><span class="si">{}</span><span class="s1">&lt;/i&gt;&lt;/b&gt;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">row_index</span> <span class="o">+</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Values</span>
        <span class="k">for</span> <span class="n">col_index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">row_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ditto</span> <span class="ow">and</span> <span class="n">col_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">no_ditto_cols</span> <span class="ow">and</span>
                    <span class="n">value</span> <span class="o">==</span> <span class="n">rows</span><span class="p">[</span><span class="n">row_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">col_index</span><span class="p">]):</span>
                <span class="n">html</span> <span class="o">+=</span> <span class="n">ditto_cell</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;    &lt;td class=&quot;queryresult&quot;&gt;</span><span class="si">{}</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">make_result_element</span><span class="p">(</span>
                        <span class="n">value</span><span class="p">,</span>
                        <span class="n">element_counter</span><span class="o">=</span><span class="n">element_counter</span><span class="p">,</span>
                        <span class="n">highlight_dict</span><span class="o">=</span><span class="n">highlight_dict</span><span class="p">,</span>
                        <span class="n">collapse_at_len</span><span class="o">=</span><span class="n">collapse_at_len</span><span class="p">,</span>
                        <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
                        <span class="n">line_length</span><span class="o">=</span><span class="n">line_length</span><span class="p">,</span>
                        <span class="n">null</span><span class="o">=</span><span class="n">null</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;  &lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/table&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">html</span>


<span class="k">def</span> <span class="nf">single_record_html_table</span><span class="p">(</span><span class="n">fieldnames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                             <span class="n">record</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
                             <span class="n">element_counter</span><span class="p">:</span> <span class="n">HtmlElementCounter</span><span class="p">,</span>
                             <span class="n">highlight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Highlight</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">collapse_at_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">collapse_at_n_lines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">line_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">table_html</span> <span class="o">=</span> <span class="s1">&#39;&lt;table&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">col_index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
        <span class="n">fieldname</span> <span class="o">=</span> <span class="n">fieldnames</span><span class="p">[</span><span class="n">col_index</span><span class="p">]</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="s1">&#39;  &lt;tr class=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;stripy_even&quot;</span> <span class="k">if</span> <span class="n">col_index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;stripy_odd&quot;</span>
        <span class="p">)</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="s1">&#39;    &lt;th&gt;</span><span class="si">{}</span><span class="s1">&lt;/th&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">fieldname</span><span class="p">))</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s1">&#39;    &lt;td class=&quot;queryresult&quot;&gt;</span><span class="si">{}</span><span class="s1">&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">make_result_element</span><span class="p">(</span>
                    <span class="n">value</span><span class="p">,</span>
                    <span class="n">element_counter</span><span class="o">=</span><span class="n">element_counter</span><span class="p">,</span>
                    <span class="n">highlight_dict</span><span class="o">=</span><span class="n">highlight_dict</span><span class="p">,</span>
                    <span class="n">collapse_at_len</span><span class="o">=</span><span class="n">collapse_at_len</span><span class="p">,</span>
                    <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
                    <span class="n">line_length</span><span class="o">=</span><span class="n">line_length</span><span class="p">,</span>
                    <span class="n">collapsed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="s1">&#39;  &lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">table_html</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/table&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">table_html</span>


<span class="k">def</span> <span class="nf">render_resultset</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                     <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
                     <span class="n">highlights</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">QuerySet</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Highlight</span><span class="p">]],</span>
                     <span class="n">collapse_at_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">collapse_at_n_lines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">line_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">ditto</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">ditto_html</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="c1"># Query</span>
    <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_missing_query</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">query</span><span class="o">.</span><span class="n">get_executed_cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">get_fieldnames_from_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">rowcount</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
            <span class="n">query</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">n_records</span><span class="o">=</span><span class="n">rowcount</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">query</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">failed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fail_msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render_bad_query</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>
    <span class="n">row_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)))</span>
    <span class="c1"># We don&#39;t need to process all rows before we paginate.</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">row_indexes</span><span class="p">)</span>
    <span class="n">start_index</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">start_index</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">end_index</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">end_index</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">display_rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Highlights</span>
    <span class="n">highlight_dict</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">as_ordered_dict</span><span class="p">(</span><span class="n">highlights</span><span class="p">)</span>
    <span class="c1"># Table</span>
    <span class="n">element_counter</span> <span class="o">=</span> <span class="n">HtmlElementCounter</span><span class="p">()</span>
    <span class="n">table_html</span> <span class="o">=</span> <span class="n">resultset_html_table</span><span class="p">(</span>
        <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">,</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">display_rows</span><span class="p">,</span>
        <span class="n">element_counter</span><span class="o">=</span><span class="n">element_counter</span><span class="p">,</span>
        <span class="n">start_index</span><span class="o">=</span><span class="n">start_index</span><span class="p">,</span>
        <span class="n">highlight_dict</span><span class="o">=</span><span class="n">highlight_dict</span><span class="p">,</span>
        <span class="n">collapse_at_len</span><span class="o">=</span><span class="n">collapse_at_len</span><span class="p">,</span>
        <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
        <span class="n">line_length</span><span class="o">=</span><span class="n">line_length</span><span class="p">,</span>
        <span class="n">ditto</span><span class="o">=</span><span class="n">ditto</span><span class="p">,</span>
        <span class="n">ditto_html</span><span class="o">=</span><span class="n">ditto_html</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Render</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;table_html&#39;</span><span class="p">:</span> <span class="n">table_html</span><span class="p">,</span>
        <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
        <span class="s1">&#39;rowcount&#39;</span><span class="p">:</span> <span class="n">rowcount</span><span class="p">,</span>
        <span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="n">prettify_sql_html</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">get_original_sql</span><span class="p">()),</span>
        <span class="s1">&#39;nav_on_results&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;query_result.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">render_resultset_recordwise</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                                <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
                                <span class="n">highlights</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">QuerySet</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Highlight</span><span class="p">]],</span>
                                <span class="n">collapse_at_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">collapse_at_n_lines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">line_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="c1"># Query</span>
    <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_missing_query</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">query</span><span class="o">.</span><span class="n">get_executed_cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">get_fieldnames_from_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">rowcount</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
            <span class="n">query</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">n_records</span><span class="o">=</span><span class="n">rowcount</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="n">query</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="n">failed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fail_msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render_bad_query</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>
    <span class="n">row_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)))</span>
    <span class="c1"># We don&#39;t need to process all rows before we paginate.</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">row_indexes</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Highlights</span>
    <span class="n">highlight_dict</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">as_ordered_dict</span><span class="p">(</span><span class="n">highlights</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">record_index</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">start_index</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">record_index</span><span class="p">]</span>
        <span class="c1"># Table</span>
        <span class="n">element_counter</span> <span class="o">=</span> <span class="n">HtmlElementCounter</span><span class="p">()</span>
        <span class="n">table_html</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;&lt;i&gt;Record </span><span class="si">{}</span><span class="s1">&lt;/i&gt;&lt;/p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">start_index</span><span class="p">())</span>
        <span class="n">table_html</span> <span class="o">+=</span> <span class="n">single_record_html_table</span><span class="p">(</span>
            <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">,</span>
            <span class="n">record</span><span class="o">=</span><span class="n">record</span><span class="p">,</span>
            <span class="n">element_counter</span><span class="o">=</span><span class="n">element_counter</span><span class="p">,</span>
            <span class="n">highlight_dict</span><span class="o">=</span><span class="n">highlight_dict</span><span class="p">,</span>
            <span class="n">collapse_at_len</span><span class="o">=</span><span class="n">collapse_at_len</span><span class="p">,</span>
            <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
            <span class="n">line_length</span><span class="o">=</span><span class="n">line_length</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">table_html</span> <span class="o">=</span> <span class="s2">&quot;&lt;b&gt;No rows returned.&lt;/b&gt;&quot;</span>
    <span class="c1"># Render</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;table_html&#39;</span><span class="p">:</span> <span class="n">table_html</span><span class="p">,</span>
        <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
        <span class="s1">&#39;rowcount&#39;</span><span class="p">:</span> <span class="n">rowcount</span><span class="p">,</span>
        <span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="n">prettify_sql_html</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">get_original_sql</span><span class="p">()),</span>
        <span class="s1">&#39;nav_on_results_recordwise&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;query_result.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">render_missing_query</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;query_missing.html&#39;</span><span class="p">,</span> <span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">render_bad_query</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                     <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span>
                     <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">recover_info_from_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
    <span class="n">final_sql</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sql&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;original_sql&#39;</span><span class="p">:</span> <span class="n">prettify_sql_html</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">get_original_sql</span><span class="p">()),</span>
        <span class="s1">&#39;final_sql&#39;</span><span class="p">:</span> <span class="n">prettify_sql_and_args</span><span class="p">(</span><span class="n">final_sql</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
        <span class="s1">&#39;exception&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">exception</span><span class="p">),</span>
        <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;query_bad.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">render_bad_query_id</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">query_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;query_id&#39;</span><span class="p">:</span> <span class="n">query_id</span><span class="p">}</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;query_bad_id.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Highlights</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="highlight_edit_select"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.highlight_edit_select">[docs]</a><span class="k">def</span> <span class="nf">highlight_edit_select</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Edit or select highlighting for current query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_highlights</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>\
                                      <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;colour&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AddHighlightForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">colour</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;colour&#39;</span><span class="p">]</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
            <span class="n">identicals</span> <span class="o">=</span> <span class="n">all_highlights</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">identicals</span><span class="p">:</span>
                <span class="n">identicals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">highlight</span> <span class="o">=</span> <span class="n">Highlight</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                                      <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">highlight</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;highlight&#39;</span><span class="p">)</span>

    <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;colour&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">AddHighlightForm</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">active_highlights</span> <span class="o">=</span> <span class="n">all_highlights</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">highlight_dict</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">as_ordered_dict</span><span class="p">(</span><span class="n">active_highlights</span><span class="p">)</span>
    <span class="n">highlight_descriptions</span> <span class="o">=</span> <span class="n">get_highlight_descriptions</span><span class="p">(</span><span class="n">highlight_dict</span><span class="p">)</span>
    <span class="n">highlights</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">all_highlights</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;highlights&#39;</span><span class="p">:</span> <span class="n">highlights</span><span class="p">,</span>
        <span class="s1">&#39;nav_on_highlight&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;N_CSS_HIGHLIGHT_CLASSES&#39;</span><span class="p">:</span> <span class="n">N_CSS_HIGHLIGHT_CLASSES</span><span class="p">,</span>
        <span class="s1">&#39;highlight_descriptions&#39;</span><span class="p">:</span> <span class="n">highlight_descriptions</span><span class="p">,</span>
        <span class="s1">&#39;colourlist&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N_CSS_HIGHLIGHT_CLASSES</span><span class="p">)),</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;highlight_edit_select.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">highlight_activate</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                       <span class="n">highlight_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">validate_blank_form</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">highlight</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Highlight</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">highlight_id</span><span class="p">)</span>  <span class="c1"># type: Highlight</span>
    <span class="n">highlight</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;highlight&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">highlight_deactivate</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                         <span class="n">highlight_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">validate_blank_form</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">highlight</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Highlight</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">highlight_id</span><span class="p">)</span>  <span class="c1"># type: Highlight</span>
    <span class="n">highlight</span><span class="o">.</span><span class="n">deactivate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;highlight&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">highlight_delete</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                     <span class="n">highlight_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">validate_blank_form</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">highlight</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Highlight</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">highlight_id</span><span class="p">)</span>  <span class="c1"># type: Highlight</span>
    <span class="n">highlight</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;highlight&#39;</span><span class="p">)</span>


<span class="c1"># def render_bad_highlight_id(request, highlight_id):</span>
<span class="c1">#     context = {&#39;highlight_id&#39;: highlight_id}</span>
<span class="c1">#     context.update(query_context(request))</span>
<span class="c1">#     return render(request, &#39;highlight_bad_id.html&#39;, context)</span>


<div class="viewcode-block" id="get_highlight_descriptions"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.get_highlight_descriptions">[docs]</a><span class="k">def</span> <span class="nf">get_highlight_descriptions</span><span class="p">(</span>
        <span class="n">highlight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Highlight</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of length up to N_CSS_HIGHLIGHT_CLASSES of HTML</span>
<span class="sd">    elements illustrating the highlights.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_CSS_HIGHLIGHT_CLASSES</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">highlight_dict</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">highlight_text</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">highlight_dict</span><span class="p">[</span><span class="n">n</span><span class="p">]]))</span>
    <span class="k">return</span> <span class="n">desc</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># PID lookup</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># In general with these database-choosing functions, don&#39;t redirect between</span>
<span class="c1"># the &quot;generic&quot; and &quot;database-specific&quot; views using POST, because we can&#39;t then</span>
<span class="c1"># add default values to a new form (since the request.POST object is</span>
<span class="c1"># populated and immutable). Use a dbname query parameter as well.</span>
<span class="c1"># (That doesn&#39;t make it HTTP GET; it makes it HTTP POST with query parameters.)</span>

<div class="viewcode-block" id="pid_rid_lookup"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.pid_rid_lookup">[docs]</a><span class="k">def</span> <span class="nf">pid_rid_lookup</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                   <span class="n">with_db_url_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">html_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common functionality for pidlookup, ridlookup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbinfolist</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">dbs_with_secret_map</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dbinfolist</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generic_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;No databases with lookup map!&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">dbinfolist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="n">with_db_url_name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">dbname</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">DatabasePickerForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dbinfolist</span><span class="o">=</span><span class="n">dbinfolist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">dbname</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span>
                <span class="n">reverse</span><span class="p">(</span><span class="n">with_db_url_name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">dbname</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">html_filename</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>


<div class="viewcode-block" id="pid_rid_lookup_with_db"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.pid_rid_lookup_with_db">[docs]</a><span class="k">def</span> <span class="nf">pid_rid_lookup_with_db</span><span class="p">(</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
        <span class="n">dbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">form_html_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">formclass</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">result_html_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common functionality for pidlookup_with_db, ridlookup_with_db.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># There&#39;s a bug in the Python 3.5 typing module; we can&#39;t use</span>
    <span class="c1"># Union[Type[PidLookupForm], Type[RidLookupForm]] yet; we get</span>
    <span class="c1"># TypeError: descriptor &#39;__subclasses__&#39; of &#39;type&#39; object needs an argument</span>
    <span class="c1"># ... see https://github.com/python/typing/issues/266</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dbinfo</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_dbinfo_by_name</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generic_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                             <span class="s2">&quot;No research database named </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">))</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">formclass</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dbinfo</span><span class="o">=</span><span class="n">dbinfo</span><span class="p">)</span>  <span class="c1"># type: Union[PidLookupForm, RidLookupForm]  # noqa</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>  <span class="c1"># type: List[int]</span>
        <span class="n">mpids</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mpids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>  <span class="c1"># type: List[int]</span>
        <span class="n">trids</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>  <span class="c1"># type: List[int]</span>
        <span class="n">rids</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
        <span class="n">mrids</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mrids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
        <span class="k">return</span> <span class="n">render_lookup</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">dbinfo</span><span class="o">=</span><span class="n">dbinfo</span><span class="p">,</span>
                             <span class="n">result_html_filename</span><span class="o">=</span><span class="n">result_html_filename</span><span class="p">,</span>
                             <span class="n">pids</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">mpids</span><span class="o">=</span><span class="n">mpids</span><span class="p">,</span>
                             <span class="n">trids</span><span class="o">=</span><span class="n">trids</span><span class="p">,</span> <span class="n">rids</span><span class="o">=</span><span class="n">rids</span><span class="p">,</span> <span class="n">mrids</span><span class="o">=</span><span class="n">mrids</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;db_name&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;db_description&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form_html_filename</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<div class="viewcode-block" id="pidlookup"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.pidlookup">[docs]</a><span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_superuser</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pidlookup</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Look up PID information from RID information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pid_rid_lookup</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
                          <span class="n">with_db_url_name</span><span class="o">=</span><span class="s2">&quot;pidlookup_with_db&quot;</span><span class="p">,</span>
                          <span class="n">html_filename</span><span class="o">=</span><span class="s2">&quot;pid_lookup_choose_db.html&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pidlookup_with_db"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.pidlookup_with_db">[docs]</a><span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_superuser</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pidlookup_with_db</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                      <span class="n">dbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Look up PID information from RID information, for a specific database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pid_rid_lookup_with_db</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
        <span class="n">dbname</span><span class="o">=</span><span class="n">dbname</span><span class="p">,</span>
        <span class="n">form_html_filename</span><span class="o">=</span><span class="s1">&#39;pid_lookup_form.html&#39;</span><span class="p">,</span>
        <span class="n">formclass</span><span class="o">=</span><span class="n">PidLookupForm</span><span class="p">,</span>
        <span class="n">result_html_filename</span><span class="o">=</span><span class="s1">&#39;pid_lookup_result.html&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ridlookup"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.ridlookup">[docs]</a><span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_clinician</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ridlookup</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Look up RID information from PID information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pid_rid_lookup</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
                          <span class="n">with_db_url_name</span><span class="o">=</span><span class="s2">&quot;ridlookup_with_db&quot;</span><span class="p">,</span>
                          <span class="n">html_filename</span><span class="o">=</span><span class="s2">&quot;rid_lookup_choose_db.html&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ridlookup_with_db"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.ridlookup_with_db">[docs]</a><span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_clinician</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ridlookup_with_db</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                      <span class="n">dbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Look up RID information from PID information, for a specific database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pid_rid_lookup_with_db</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
        <span class="n">dbname</span><span class="o">=</span><span class="n">dbname</span><span class="p">,</span>
        <span class="n">form_html_filename</span><span class="o">=</span><span class="s1">&#39;rid_lookup_form.html&#39;</span><span class="p">,</span>
        <span class="n">formclass</span><span class="o">=</span><span class="n">RidLookupForm</span><span class="p">,</span>
        <span class="n">result_html_filename</span><span class="o">=</span><span class="s1">&#39;rid_lookup_result.html&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="render_lookup"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.render_lookup">[docs]</a><span class="k">def</span> <span class="nf">render_lookup</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                  <span class="n">dbinfo</span><span class="p">:</span> <span class="n">SingleResearchDatabase</span><span class="p">,</span>
                  <span class="n">result_html_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">trids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">rids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">mrids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">pids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">mpids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shows the output of a PID/RID lookup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if not request.user.superuser:</span>
    <span class="c1">#    return HttpResponse(&#39;Forbidden&#39;, status=403)</span>
    <span class="c1">#    # http://stackoverflow.com/questions/3297048/403-forbidden-vs-401-unauthorized-http-responses  # noqa</span>
    <span class="n">trids</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">trids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">trids</span>
    <span class="n">rids</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">rids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rids</span>
    <span class="n">mrids</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">mrids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mrids</span>
    <span class="n">pids</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">pids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pids</span>
    <span class="n">mpids</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">mpids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mpids</span>

    <span class="k">assert</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">secret_lookup_db</span>
    <span class="n">lookups</span> <span class="o">=</span> <span class="n">PidLookup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">secret_lookup_db</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">trid__in</span><span class="o">=</span><span class="n">trids</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">rid__in</span><span class="o">=</span><span class="n">rids</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">mrid__in</span><span class="o">=</span><span class="n">mrids</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">pid__in</span><span class="o">=</span><span class="n">pids</span><span class="p">)</span> <span class="o">|</span>
        <span class="n">Q</span><span class="p">(</span><span class="n">mpid__in</span><span class="o">=</span><span class="n">mpids</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;pid&#39;</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;lookups&#39;</span><span class="p">:</span> <span class="n">lookups</span><span class="p">,</span>
        <span class="s1">&#39;trid_field&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">trid_field</span><span class="p">,</span>
        <span class="s1">&#39;trid_description&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">trid_description</span><span class="p">,</span>
        <span class="s1">&#39;rid_field&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_field</span><span class="p">,</span>
        <span class="s1">&#39;rid_description&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_description</span><span class="p">,</span>
        <span class="s1">&#39;mrid_field&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">mrid_field</span><span class="p">,</span>
        <span class="s1">&#39;mrid_description&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">mrid_description</span><span class="p">,</span>
        <span class="s1">&#39;pid_description&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">pid_description</span><span class="p">,</span>
        <span class="s1">&#39;mpid_description&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">mpid_description</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">result_html_filename</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Research database structure</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">structure_table_long</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">colinfolist</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_colinfolist</span><span class="p">()</span>
    <span class="n">rowcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colinfolist</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;paginated&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;colinfolist&#39;</span><span class="p">:</span> <span class="n">colinfolist</span><span class="p">,</span>
        <span class="s1">&#39;rowcount&#39;</span><span class="p">:</span> <span class="n">rowcount</span><span class="p">,</span>
        <span class="s1">&#39;default_database&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_database_name</span><span class="p">(),</span>
        <span class="s1">&#39;default_schema&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_schema_name</span><span class="p">(),</span>
        <span class="s1">&#39;with_database&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">uses_database_level</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;database_structure.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">structure_table_paginated</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">colinfolist</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_colinfolist</span><span class="p">()</span>
    <span class="n">rowcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colinfolist</span><span class="p">)</span>
    <span class="n">colinfolist</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">colinfolist</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;paginated&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;colinfolist&#39;</span><span class="p">:</span> <span class="n">colinfolist</span><span class="p">,</span>
        <span class="s1">&#39;rowcount&#39;</span><span class="p">:</span> <span class="n">rowcount</span><span class="p">,</span>
        <span class="s1">&#39;default_database&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_database_name</span><span class="p">(),</span>
        <span class="s1">&#39;default_schema&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_schema_name</span><span class="p">(),</span>
        <span class="s1">&#39;with_database&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">uses_database_level</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;database_structure.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="nd">@django_cache_function</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># @lru_cache(maxsize=None)</span>
<span class="k">def</span> <span class="nf">get_structure_tree_html</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">table_to_colinfolist</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_colinfolist_by_tables</span><span class="p">()</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">element_counter</span> <span class="o">=</span> <span class="n">HtmlElementCounter</span><span class="p">()</span>
    <span class="n">grammar</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">grammar</span>
    <span class="k">for</span> <span class="n">table_id</span><span class="p">,</span> <span class="n">colinfolist</span> <span class="ow">in</span> <span class="n">table_to_colinfolist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">html_table</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span>
            <span class="s1">&#39;database_structure_table.html&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;colinfolist&#39;</span><span class="p">:</span> <span class="n">colinfolist</span><span class="p">,</span>
                <span class="s1">&#39;default_database&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_database_name</span><span class="p">(),</span>  <span class="c1"># noqa</span>
                <span class="s1">&#39;default_schema&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_schema_name</span><span class="p">(),</span>  <span class="c1"># noqa</span>
                <span class="s1">&#39;with_database&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">uses_database_level</span><span class="p">()</span>
            <span class="p">})</span>
        <span class="n">cd_button</span> <span class="o">=</span> <span class="n">element_counter</span><span class="o">.</span><span class="n">visibility_div_spanbutton</span><span class="p">()</span>
        <span class="n">cd_content</span> <span class="o">=</span> <span class="n">element_counter</span><span class="o">.</span><span class="n">visibility_div_contentdiv</span><span class="p">(</span>
            <span class="n">contents</span><span class="o">=</span><span class="n">html_table</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s1">&#39;&lt;div class=&quot;titlecolour&quot;&gt;</span><span class="si">{db_schema}</span><span class="s1">.&lt;b&gt;</span><span class="si">{table}</span><span class="s1">&lt;/b&gt;</span><span class="si">{button}</span><span class="s1">&lt;/div&gt;&#39;</span>
            <span class="s1">&#39;</span><span class="si">{cd}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">db_schema</span><span class="o">=</span><span class="n">table_id</span><span class="o">.</span><span class="n">database_schema_part</span><span class="p">(</span><span class="n">grammar</span><span class="p">),</span>
                <span class="n">table</span><span class="o">=</span><span class="n">table_id</span><span class="o">.</span><span class="n">table_part</span><span class="p">(</span><span class="n">grammar</span><span class="p">),</span>
                <span class="n">button</span><span class="o">=</span><span class="n">cd_button</span><span class="p">,</span>
                <span class="n">cd</span><span class="o">=</span><span class="n">cd_content</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">content</span>


<span class="k">def</span> <span class="nf">structure_tree</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">get_structure_tree_html</span><span class="p">(),</span>
        <span class="s1">&#39;default_database&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_database_name</span><span class="p">(),</span>
        <span class="s1">&#39;default_schema&#39;</span><span class="p">:</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_schema_name</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;database_structure_tree.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="c1"># noinspection PyUnusedLocal</span>
<span class="k">def</span> <span class="nf">structure_tsv</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">file_response</span><span class="p">(</span>
        <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_tsv</span><span class="p">(),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TSV</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;structure.tsv&quot;</span>
    <span class="p">)</span>


<span class="c1"># noinspection PyUnusedLocal</span>
<span class="k">def</span> <span class="nf">structure_excel</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">file_response</span><span class="p">(</span>
        <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_excel</span><span class="p">(),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">TSV</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;structure.xlsx&quot;</span>
    <span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Local help on structure</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">local_structure_help</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DATABASE_HELP_HTML_FILENAME</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">DATABASE_HELP_HTML_FILENAME</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&lt;p&gt;No local help available.&lt;/p&gt;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;local_structure_help.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># SQL helpers</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">textmatch</span><span class="p">(</span><span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">fragment</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">as_fulltext</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
              <span class="n">dialect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mysql&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">as_fulltext</span> <span class="ow">and</span> <span class="n">dialect</span> <span class="o">==</span> <span class="s1">&#39;mysql&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;MATCH(</span><span class="si">{column}</span><span class="s2">) AGAINST (&#39;</span><span class="si">{fragment}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">column</span><span class="o">=</span><span class="n">column_name</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="n">fragment</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">as_fulltext</span> <span class="ow">and</span> <span class="n">dialect</span> <span class="o">==</span> <span class="s1">&#39;mssql&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CONTAINS(</span><span class="si">{column}</span><span class="s2">, &#39;</span><span class="si">{fragment}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">column</span><span class="o">=</span><span class="n">column_name</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="n">fragment</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{column}</span><span class="s2"> LIKE &#39;%</span><span class="si">{fragment}</span><span class="s2">%&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">column</span><span class="o">=</span><span class="n">column_name</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="n">fragment</span><span class="p">)</span>


<div class="viewcode-block" id="textfinder_sql"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.textfinder_sql">[docs]</a><span class="k">def</span> <span class="nf">textfinder_sql</span><span class="p">(</span><span class="n">patient_id_fieldname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">fragment</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">min_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="n">use_fulltext_index</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">include_content</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">include_datetime</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                   <span class="n">patient_id_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">extra_fieldname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">extra_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns SQL to find the text in fragment across all tables that contain the</span>
<span class="sd">    field indicated by patient_id_fieldname, where the length of the text field</span>
<span class="sd">    is at least min_length.</span>

<span class="sd">    use_fulltext_index: use database full-text indexing</span>
<span class="sd">    include_content: include the text fields in the output</span>
<span class="sd">    patient_id_value: restrict to a single patient</span>

<span class="sd">    Will raise ValueError if no tables match the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grammar</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">grammar</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">tables_containing_field</span><span class="p">(</span>
        <span class="n">patient_id_fieldname</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No tables containing fieldname: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">patient_id_fieldname</span><span class="p">))</span>
    <span class="n">have_pid_value</span> <span class="o">=</span> <span class="n">patient_id_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">patient_id_value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">have_pid_value</span><span class="p">:</span>
        <span class="n">pidclause</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{patient_id_fieldname}</span><span class="s2"> = </span><span class="si">{value}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">patient_id_fieldname</span><span class="o">=</span><span class="n">patient_id_fieldname</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">escape_sql_string_or_int_literal</span><span class="p">(</span><span class="n">patient_id_value</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pidclause</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">using_extra</span> <span class="o">=</span> <span class="n">extra_fieldname</span> <span class="ow">and</span> <span class="n">extra_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">table_heading</span> <span class="o">=</span> <span class="s2">&quot;_table_name&quot;</span>
    <span class="n">contents_colname_heading</span> <span class="o">=</span> <span class="s2">&quot;_column_name&quot;</span>
    <span class="n">datetime_heading</span> <span class="o">=</span> <span class="s2">&quot;_datetime&quot;</span>

    <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>

    <span class="k">def</span> <span class="nf">add_query</span><span class="p">(</span><span class="n">table_ident</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">extra_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">date_value_select</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">extra_conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">selectcols</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
        <span class="c1"># Patient ID(s); date</span>
        <span class="k">if</span> <span class="n">using_extra</span><span class="p">:</span>
            <span class="n">selectcols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{lit}</span><span class="s1"> AS </span><span class="si">{ef}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">lit</span><span class="o">=</span><span class="n">escape_sql_string_or_int_literal</span><span class="p">(</span><span class="n">extra_value</span><span class="p">),</span>
                <span class="n">ef</span><span class="o">=</span><span class="n">extra_fieldname</span>
            <span class="p">))</span>
        <span class="n">selectcols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patient_id_fieldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_datetime</span><span class="p">:</span>
            <span class="n">selectcols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> AS </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date_value_select</span><span class="p">,</span>
                                                <span class="n">datetime_heading</span><span class="p">))</span>
        <span class="c1"># +/- table/column/content</span>
        <span class="n">selectcols</span> <span class="o">+=</span> <span class="n">extra_cols</span>
        <span class="c1"># Build query</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;SELECT </span><span class="si">{cols}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FROM </span><span class="si">{table}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">selectcols</span><span class="p">),</span>
                                    <span class="n">table</span><span class="o">=</span><span class="n">table_ident</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
        <span class="k">if</span> <span class="n">have_pid_value</span><span class="p">:</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pidclause</span><span class="p">)</span>
        <span class="n">conditions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_conditions</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WHERE &quot;</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
        <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">table_id</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">text_columns</span><span class="p">(</span>
            <span class="n">table_id</span><span class="o">=</span><span class="n">table_id</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="n">min_length</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">table_identifier</span> <span class="o">=</span> <span class="n">table_id</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
        <span class="n">date_col</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_date_column</span><span class="p">(</span>
            <span class="n">table</span><span class="o">=</span><span class="n">table_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date_col</span><span class="p">:</span>
            <span class="n">date_identifier</span> <span class="o">=</span> <span class="n">date_col</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">date_identifier</span> <span class="o">=</span> <span class="s2">&quot;NULL&quot;</span>

        <span class="k">if</span> <span class="n">include_content</span><span class="p">:</span>
            <span class="c1"># Content required; therefore, one query per text column.</span>
            <span class="n">table_select</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; AS </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">escape_sql_string_literal</span><span class="p">(</span><span class="n">table_identifier</span><span class="p">),</span>
                <span class="n">table_heading</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">columninfo</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="n">column_identifier</span> <span class="o">=</span> <span class="n">columninfo</span><span class="o">.</span><span class="n">column_id</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
                <span class="n">contentcol_name_select</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; AS </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">column_identifier</span><span class="p">,</span> <span class="n">contents_colname_heading</span><span class="p">)</span>
                <span class="n">content_select</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> AS _content&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_identifier</span><span class="p">)</span>
                <span class="n">add_query</span><span class="p">(</span><span class="n">table_ident</span><span class="o">=</span><span class="n">table_identifier</span><span class="p">,</span>
                          <span class="n">extra_cols</span><span class="o">=</span><span class="p">[</span><span class="n">table_select</span><span class="p">,</span>
                                      <span class="n">contentcol_name_select</span><span class="p">,</span>
                                      <span class="n">content_select</span><span class="p">],</span>
                          <span class="n">date_value_select</span><span class="o">=</span><span class="n">date_identifier</span><span class="p">,</span>
                          <span class="n">extra_conditions</span><span class="o">=</span><span class="p">[</span>
                              <span class="n">textmatch</span><span class="p">(</span>
                                  <span class="n">column_name</span><span class="o">=</span><span class="n">column_identifier</span><span class="p">,</span>
                                  <span class="n">fragment</span><span class="o">=</span><span class="n">fragment</span><span class="p">,</span>
                                  <span class="n">as_fulltext</span><span class="o">=</span><span class="p">(</span><span class="n">columninfo</span><span class="o">.</span><span class="n">indexed_fulltext</span> <span class="ow">and</span>
                                               <span class="n">use_fulltext_index</span><span class="p">)</span>
                              <span class="p">)</span>
                          <span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Content not required; therefore, one query per table.</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
            <span class="k">for</span> <span class="n">columninfo</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">textmatch</span><span class="p">(</span>
                    <span class="n">column_name</span><span class="o">=</span><span class="n">columninfo</span><span class="o">.</span><span class="n">column_id</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">),</span>
                    <span class="n">fragment</span><span class="o">=</span><span class="n">fragment</span><span class="p">,</span>
                    <span class="n">as_fulltext</span><span class="o">=</span><span class="p">(</span><span class="n">columninfo</span><span class="o">.</span><span class="n">indexed_fulltext</span> <span class="ow">and</span>
                                 <span class="n">use_fulltext_index</span><span class="p">)</span>
                <span class="p">))</span>
            <span class="n">add_query</span><span class="p">(</span><span class="n">table_ident</span><span class="o">=</span><span class="n">table_identifier</span><span class="p">,</span>
                      <span class="n">extra_cols</span><span class="o">=</span><span class="p">[],</span>
                      <span class="n">date_value_select</span><span class="o">=</span><span class="n">date_identifier</span><span class="p">,</span>
                      <span class="n">extra_conditions</span><span class="o">=</span><span class="p">[</span>
                          <span class="s2">&quot;(</span><span class="se">\n</span><span class="s2">    </span><span class="si">{}</span><span class="se">\n</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">))</span>
                      <span class="p">])</span>

    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">UNION</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sql</span><span class="p">:</span>
        <span class="n">order_by_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">using_extra</span><span class="p">:</span>
            <span class="n">order_by_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extra_fieldname</span><span class="p">)</span>
        <span class="n">order_by_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patient_id_fieldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_datetime</span><span class="p">:</span>
            <span class="n">order_by_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime_heading</span> <span class="o">+</span> <span class="s2">&quot; DESC&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_content</span><span class="p">:</span>
            <span class="n">order_by_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">table_heading</span><span class="p">,</span> <span class="n">contents_colname_heading</span><span class="p">])</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ORDER BY &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_by_cols</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sql</span></div>


<div class="viewcode-block" id="common_find_text"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.common_find_text">[docs]</a><span class="k">def</span> <span class="nf">common_find_text</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                     <span class="n">dbinfo</span><span class="p">:</span> <span class="n">SingleResearchDatabase</span><span class="p">,</span>
                     <span class="n">form_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">SQLHelperTextAnywhereForm</span><span class="p">],</span>
                     <span class="n">default_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
                     <span class="n">permit_pid_search</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                     <span class="n">html_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates SQL to find text anywhere in the database(s) via a UNION query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># When you forget about Django forms, go back to:</span>
    <span class="c1"># http://www.slideshare.net/pydanny/advanced-django-forms-usage</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># What may the user use to look up patients?</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">fk_options</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[FieldPickerInfo]</span>
    <span class="k">if</span> <span class="n">permit_pid_search</span><span class="p">:</span>
        <span class="n">fk_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FieldPickerInfo</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">pid_pseudo_field</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">pid_pseudo_field</span><span class="p">,</span>
                                        <span class="n">dbinfo</span><span class="o">.</span><span class="n">pid_description</span><span class="p">),</span>
            <span class="n">type_</span><span class="o">=</span><span class="n">PatientFieldPythonTypes</span><span class="o">.</span><span class="n">PID</span><span class="p">,</span>
            <span class="n">permits_empty_id</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">))</span>
        <span class="n">fk_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FieldPickerInfo</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">mpid_pseudo_field</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">dbinfo</span><span class="o">.</span><span class="n">mpid_pseudo_field</span><span class="p">,</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">mpid_description</span><span class="p">),</span>
            <span class="n">type_</span><span class="o">=</span><span class="n">PatientFieldPythonTypes</span><span class="o">.</span><span class="n">MPID</span><span class="p">,</span>
            <span class="n">permits_empty_id</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">))</span>
        <span class="k">assert</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">secret_lookup_db</span>
        <span class="n">default_values</span><span class="p">[</span><span class="s1">&#39;fkname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">pid_pseudo_field</span>
    <span class="n">fk_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">FieldPickerInfo</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_field</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_field</span><span class="p">,</span>
                                                    <span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_description</span><span class="p">),</span>
                        <span class="n">type_</span><span class="o">=</span><span class="n">PatientFieldPythonTypes</span><span class="o">.</span><span class="n">RID</span><span class="p">,</span>
                        <span class="n">permits_empty_id</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">secret_lookup_db</span><span class="p">:</span>
        <span class="n">fk_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">FieldPickerInfo</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">mrid_field</span><span class="p">,</span>
                            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">dbinfo</span><span class="o">.</span><span class="n">mrid_field</span><span class="p">,</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">mrid_description</span><span class="p">),</span>
                            <span class="n">type_</span><span class="o">=</span><span class="n">PatientFieldPythonTypes</span><span class="o">.</span><span class="n">MRID</span><span class="p">,</span>
                            <span class="n">permits_empty_id</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># We don&#39;t want to make too much of the TRID. Let&#39;s not offer it as</span>
    <span class="c1"># a lookup option. If performance becomes a major problem with these</span>
    <span class="c1"># queries, we could always say &quot;if dbinfo.secret_lookup_db, then</span>
    <span class="c1"># look up the TRID from the RID (or whatever we&#39;re using)&quot;.</span>
    <span class="c1">#</span>
    <span class="c1"># FieldPickerInfo(value=dbinfo.trid_field,</span>
    <span class="c1">#                 description=&quot;{}: {}&quot;.format(dbinfo.trid_field,</span>
    <span class="c1">#                                             dbinfo.trid_description),</span>
    <span class="c1">#                 type_=PatientFieldPythonTypes.TRID),</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">form_class</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="n">default_values</span><span class="p">,</span> <span class="n">fk_options</span><span class="o">=</span><span class="n">fk_options</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="n">patient_id_fieldname</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;fkname&#39;</span><span class="p">]</span>
        <span class="n">pidvalue</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">]</span>
        <span class="n">min_length</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;min_length&#39;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Whare are we going to use internally for the lookup?</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># For patient lookups, a TRID is quick but not so helpful for</span>
        <span class="c1"># clinicians. Use the RID.</span>
        <span class="k">if</span> <span class="n">patient_id_fieldname</span> <span class="o">==</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">pid_pseudo_field</span><span class="p">:</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">PidLookup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">secret_lookup_db</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">pidvalue</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="p">)</span>  <span class="c1"># type: PidLookup</span>
            <span class="k">if</span> <span class="n">lookup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">generic_error</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span> <span class="s2">&quot;No patient with PID </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pidvalue</span><span class="p">))</span>
            <span class="c1"># Replace:</span>
            <span class="n">extra_fieldname</span> <span class="o">=</span> <span class="n">patient_id_fieldname</span>
            <span class="n">extra_value</span> <span class="o">=</span> <span class="n">pidvalue</span>
            <span class="n">patient_id_fieldname</span> <span class="o">=</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_field</span>
            <span class="n">pidvalue</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="n">rid</span>  <span class="c1"># string</span>
        <span class="k">elif</span> <span class="n">patient_id_fieldname</span> <span class="o">==</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">mpid_pseudo_field</span><span class="p">:</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">PidLookup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">secret_lookup_db</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mpid</span><span class="o">=</span><span class="n">pidvalue</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="p">)</span>  <span class="c1"># type: PidLookup</span>
            <span class="k">if</span> <span class="n">lookup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">generic_error</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span> <span class="s2">&quot;No patient with MPID </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pidvalue</span><span class="p">))</span>
            <span class="c1"># Replace:</span>
            <span class="n">extra_fieldname</span> <span class="o">=</span> <span class="n">patient_id_fieldname</span>
            <span class="n">extra_value</span> <span class="o">=</span> <span class="n">pidvalue</span>
            <span class="n">patient_id_fieldname</span> <span class="o">=</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_field</span>
            <span class="n">pidvalue</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="n">rid</span>  <span class="c1"># string</span>

        <span class="k">elif</span> <span class="n">patient_id_fieldname</span> <span class="o">==</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">mrid_field</span><span class="p">:</span>
            <span class="c1"># Using MRID. This is not stored in each table. Rather than have</span>
            <span class="c1"># an absolutely enormous query (SELECT stuff FROM texttable INNER</span>
            <span class="c1"># JOIN mridtable ON patient_id_stuff WHERE textttable.contents</span>
            <span class="c1"># LIKE something AND mridtable.mrid = ? UNION SELECT morestuff...)</span>
            <span class="c1"># let&#39;s look up the RID from the MRID. Consequently, we only offer</span>
            <span class="c1"># MRID lookup if we have a secret lookup table.</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">PidLookup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">dbinfo</span><span class="o">.</span><span class="n">secret_lookup_db</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mrid</span><span class="o">=</span><span class="n">pidvalue</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">lookup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">generic_error</span><span class="p">(</span>
                    <span class="n">request</span><span class="p">,</span> <span class="s2">&quot;No patient with RID </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pidvalue</span><span class="p">))</span>
            <span class="c1"># Replace:</span>
            <span class="n">extra_fieldname</span> <span class="o">=</span> <span class="n">patient_id_fieldname</span>
            <span class="n">extra_value</span> <span class="o">=</span> <span class="n">pidvalue</span>
            <span class="n">patient_id_fieldname</span> <span class="o">=</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_field</span>
            <span class="n">pidvalue</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="n">rid</span>  <span class="c1"># string</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Using RID directly (or, if we wanted to support it, TRID).</span>
            <span class="n">extra_fieldname</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">extra_value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Generate the query</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">textfinder_sql</span><span class="p">(</span>
                <span class="n">patient_id_fieldname</span><span class="o">=</span><span class="n">patient_id_fieldname</span><span class="p">,</span>
                <span class="n">fragment</span><span class="o">=</span><span class="n">escape_sql_string_literal</span><span class="p">(</span>
                    <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;fragment&#39;</span><span class="p">]),</span>
                <span class="n">min_length</span><span class="o">=</span><span class="n">min_length</span><span class="p">,</span>
                <span class="n">use_fulltext_index</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;use_fulltext_index&#39;</span><span class="p">],</span>
                <span class="n">include_content</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;include_content&#39;</span><span class="p">],</span>
                <span class="n">include_datetime</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;include_datetime&#39;</span><span class="p">],</span>
                <span class="n">patient_id_value</span><span class="o">=</span><span class="n">pidvalue</span><span class="p">,</span>
                <span class="n">extra_fieldname</span><span class="o">=</span><span class="n">extra_fieldname</span><span class="p">,</span>
                <span class="n">extra_value</span><span class="o">=</span><span class="n">extra_value</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># This SQL will link across all available research databases</span>
            <span class="c1"># where the fieldname conditions are met.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sql</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;No fields matched your criteria (text columns of minimum &quot;</span>
                    <span class="s2">&quot;length </span><span class="si">{}</span><span class="s2"> in tables containing field </span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">min_length</span><span class="p">,</span> <span class="n">patient_id_fieldname</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">generic_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Run, save, or display the query</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="s1">&#39;submit_save&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query_submit</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;submit_run&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query_submit</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;sql_fragment.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="n">sql</span><span class="p">})</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Offer the starting choices</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">html_filename</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;db_name&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;db_description&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
    <span class="p">})</span></div>


<div class="viewcode-block" id="sqlhelper_text_anywhere"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.sqlhelper_text_anywhere">[docs]</a><span class="k">def</span> <span class="nf">sqlhelper_text_anywhere</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Picks a database, then redirects to sqlhelper_text_anywhere_with_db.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">single_research_db</span><span class="p">:</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">first_dbinfo</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;sqlhelper_text_anywhere_with_db&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">dbname</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">DatabasePickerForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">dbinfolist</span><span class="o">=</span><span class="n">research_database_info</span><span class="o">.</span><span class="n">dbinfolist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">dbname</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span>
                <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;sqlhelper_text_anywhere_with_db&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">dbname</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;sqlhelper_form_text_anywhere_choose_db.html&#39;</span><span class="p">,</span>
                      <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>


<div class="viewcode-block" id="sqlhelper_text_anywhere_with_db"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.sqlhelper_text_anywhere_with_db">[docs]</a><span class="k">def</span> <span class="nf">sqlhelper_text_anywhere_with_db</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                                    <span class="n">dbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates SQL to find text anywhere in the database(s) via a UNION query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dbinfo</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_dbinfo_by_name</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generic_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                             <span class="s2">&quot;No research database named </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">))</span>
    <span class="n">default_values</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fkname&#39;</span><span class="p">:</span> <span class="n">dbinfo</span><span class="o">.</span><span class="n">rid_field</span><span class="p">,</span>
        <span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="n">DEFAULT_MIN_TEXT_FIELD_LENGTH</span><span class="p">,</span>
        <span class="s1">&#39;use_fulltext_index&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;include_content&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;include_datetime&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">common_find_text</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
        <span class="n">dbinfo</span><span class="o">=</span><span class="n">dbinfo</span><span class="p">,</span>
        <span class="n">form_class</span><span class="o">=</span><span class="n">SQLHelperTextAnywhereForm</span><span class="p">,</span>
        <span class="n">default_values</span><span class="o">=</span><span class="n">default_values</span><span class="p">,</span>
        <span class="n">permit_pid_search</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">html_filename</span><span class="o">=</span><span class="s1">&#39;sqlhelper_form_text_anywhere.html&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="all_text_from_pid"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.all_text_from_pid">[docs]</a><span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_clinician</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">all_text_from_pid</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Picks a database, then redirects to all_text_from_pid_with_db.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbinfolist</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">dbs_with_secret_map</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dbinfolist</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generic_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;No databases with lookup map!&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dbname</span> <span class="o">=</span> <span class="n">dbinfolist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span>
            <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;all_text_from_pid_with_db&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">dbname</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">DatabasePickerForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dbinfolist</span><span class="o">=</span><span class="n">dbinfolist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">dbname</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span>
                <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;all_text_from_pid_with_db&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">dbname</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                      <span class="s1">&#39;clinician_form_all_text_from_pid_choose_db.html&#39;</span><span class="p">,</span>
                      <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span></div>


<div class="viewcode-block" id="all_text_from_pid_with_db"><a class="viewcode-back" href="../../../../autodoc/crateweb/research/views.html#crate_anon.crateweb.research.views.all_text_from_pid_with_db">[docs]</a><span class="nd">@user_passes_test</span><span class="p">(</span><span class="n">is_clinician</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">all_text_from_pid_with_db</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                              <span class="n">dbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clinician view to look up a patient&#39;s RID from their PID and display</span>
<span class="sd">    text from any field.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dbinfo</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_dbinfo_by_name</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generic_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                             <span class="s2">&quot;No research database named </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbname</span><span class="p">))</span>
    <span class="n">default_values</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;min_length&#39;</span><span class="p">:</span> <span class="n">DEFAULT_MIN_TEXT_FIELD_LENGTH</span><span class="p">,</span>
        <span class="s1">&#39;use_fulltext_index&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;include_content&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;include_datetime&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">common_find_text</span><span class="p">(</span>
        <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
        <span class="n">dbinfo</span><span class="o">=</span><span class="n">dbinfo</span><span class="p">,</span>
        <span class="n">form_class</span><span class="o">=</span><span class="n">ClinicianAllTextFromPidForm</span><span class="p">,</span>
        <span class="n">default_values</span><span class="o">=</span><span class="n">default_values</span><span class="p">,</span>
        <span class="n">permit_pid_search</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">html_filename</span><span class="o">=</span><span class="s1">&#39;clinician_form_all_text_from_pid.html&#39;</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Per-patient views: Patient Explorer</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">pe_build</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">default_database</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_database_name</span><span class="p">()</span>
    <span class="n">default_schema</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_default_schema_name</span><span class="p">()</span>
    <span class="n">with_database</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">uses_database_level</span><span class="p">()</span>
    <span class="n">manual_form</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">form</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="o">.</span><span class="n">patient_multiquery_scratchpad</span><span class="p">:</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">patient_multiquery_scratchpad</span> <span class="o">=</span> <span class="n">PatientMultiQuery</span><span class="p">()</span>
    <span class="n">pmq</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">patient_multiquery_scratchpad</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;global_clear_select&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">pmq</span><span class="o">.</span><span class="n">clear_output_columns</span><span class="p">()</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">elif</span> <span class="s1">&#39;global_clear_where&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">pmq</span><span class="o">.</span><span class="n">clear_patient_conditions</span><span class="p">()</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">elif</span> <span class="s1">&#39;global_clear_everything&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">pmq</span><span class="o">.</span><span class="n">clear_output_columns</span><span class="p">()</span>
            <span class="n">pmq</span><span class="o">.</span><span class="n">clear_patient_conditions</span><span class="p">()</span>
            <span class="n">pmq</span><span class="o">.</span><span class="n">set_override_query</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">elif</span> <span class="s1">&#39;global_save&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pmq</span><span class="o">.</span><span class="n">ok_to_run</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pe_submit</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pmq</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;global_run&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pmq</span><span class="o">.</span><span class="n">ok_to_run</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pe_submit</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pmq</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s1">&#39;global_manual_set&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">manual_form</span> <span class="o">=</span> <span class="n">ManualPeQueryForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">manual_form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="n">manual_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;sql&#39;</span><span class="p">]</span>
                <span class="n">pmq</span><span class="o">.</span><span class="n">set_override_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">elif</span> <span class="s1">&#39;global_manual_clear&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">pmq</span><span class="o">.</span><span class="n">set_override_query</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">QueryBuilderForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">database</span> <span class="o">=</span> <span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">with_database</span>
                            <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">]</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span>
                <span class="n">column_id</span> <span class="o">=</span> <span class="n">ColumnId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                                     <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;submit_select&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                    <span class="n">pmq</span><span class="o">.</span><span class="n">add_output_column</span><span class="p">(</span><span class="n">column_id</span><span class="p">)</span>  <span class="c1"># noqa</span>

                <span class="k">elif</span> <span class="s1">&#39;submit_select_star&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                    <span class="n">table_id</span> <span class="o">=</span> <span class="n">column_id</span><span class="o">.</span><span class="n">table_id</span>
                    <span class="n">all_column_ids</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">column_id</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>
                        <span class="n">research_database_info</span><span class="o">.</span><span class="n">all_columns</span><span class="p">(</span><span class="n">table_id</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_column_ids</span><span class="p">:</span>
                        <span class="n">pmq</span><span class="o">.</span><span class="n">add_output_column</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                <span class="k">elif</span> <span class="s1">&#39;submit_where&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
                    <span class="n">datatype</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;where_op&#39;</span><span class="p">]</span>
                    <span class="c1"># Value</span>
                    <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">SQL_OPS_MULTIPLE_VALUES</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">file_values_list</span>
                    <span class="k">elif</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">SQL_OPS_VALUE_UNNECESSARY</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get_cleaned_where_value</span><span class="p">()</span>
                    <span class="c1"># WHERE fragment</span>
                    <span class="n">wherecond</span> <span class="o">=</span> <span class="n">WhereCondition</span><span class="p">(</span><span class="n">column_id</span><span class="o">=</span><span class="n">column_id</span><span class="p">,</span>
                                               <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span>
                                               <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span>
                                               <span class="n">value_or_values</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">pmq</span><span class="o">.</span><span class="n">add_patient_condition</span><span class="p">(</span><span class="n">wherecond</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad form command!&quot;</span><span class="p">)</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># log.critical(&quot;not is_valid&quot;)</span>
                <span class="k">pass</span>

    <span class="n">manual_query</span> <span class="o">=</span> <span class="n">pmq</span><span class="o">.</span><span class="n">manual_patient_id_query</span>

    <span class="k">if</span> <span class="n">form</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">QueryBuilderForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">manual_form</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">manual_form</span> <span class="o">=</span> <span class="n">ManualPeQueryForm</span><span class="p">({</span><span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="n">manual_query</span><span class="p">})</span>

    <span class="n">starting_values_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">with_database</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;schema&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;column&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;where_op&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;date_value&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date_value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="c1"># Impossible to set file_value programmatically. (See querybuilder.js.)</span>
        <span class="s1">&#39;float_value&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;float_value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;int_value&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;int_value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;string_value&#39;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;string_value&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="s1">&#39;offer_where&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
        <span class="s1">&#39;form_errors&#39;</span><span class="p">:</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
        <span class="s1">&#39;default_database&#39;</span><span class="p">:</span> <span class="n">default_database</span><span class="p">,</span>
        <span class="s1">&#39;default_schema&#39;</span><span class="p">:</span> <span class="n">default_schema</span><span class="p">,</span>
        <span class="s1">&#39;with_database&#39;</span><span class="p">:</span> <span class="n">with_database</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">manual_query</span><span class="p">:</span>
        <span class="n">pmq_patient_conditions</span> <span class="o">=</span> <span class="s2">&quot;&lt;div&gt;&lt;i&gt;Overridden by manual query.&lt;/i&gt;&lt;/div&gt;&quot;</span>  <span class="c1"># noqa</span>
        <span class="n">pmq_manual_patient_query</span> <span class="o">=</span> <span class="n">prettify_sql_html</span><span class="p">(</span>
            <span class="n">pmq</span><span class="o">.</span><span class="n">manual_patient_id_query</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pmq_patient_conditions</span> <span class="o">=</span> <span class="n">pmq</span><span class="o">.</span><span class="n">pt_conditions_html</span>
        <span class="n">pmq_manual_patient_query</span> <span class="o">=</span> <span class="s2">&quot;&lt;div&gt;&lt;i&gt;None&lt;/i&gt;&lt;/div&gt;&quot;</span>
    <span class="n">pmq_final_patient_query</span> <span class="o">=</span> <span class="n">prettify_sql_html</span><span class="p">(</span><span class="n">pmq</span><span class="o">.</span><span class="n">patient_id_query</span><span class="p">(</span>
        <span class="n">with_order_by</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="n">warnings</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pmq</span><span class="o">.</span><span class="n">has_patient_id_query</span><span class="p">:</span>
        <span class="n">warnings</span> <span class="o">+=</span> <span class="s1">&#39;&lt;div class=&quot;warning&quot;&gt;No patient criteria yet&lt;/div&gt;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pmq</span><span class="o">.</span><span class="n">has_output_columns</span><span class="p">:</span>
        <span class="n">warnings</span> <span class="o">+=</span> <span class="s1">&#39;&lt;div class=&quot;warning&quot;&gt;No output columns yet&lt;/div&gt;&#39;</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;nav_on_pe_build&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;pmq_output_columns&#39;</span><span class="p">:</span> <span class="n">pmq</span><span class="o">.</span><span class="n">output_cols_html</span><span class="p">,</span>
        <span class="s1">&#39;pmq_patient_conditions&#39;</span><span class="p">:</span> <span class="n">pmq_patient_conditions</span><span class="p">,</span>
        <span class="s1">&#39;pmq_manual_patient_query&#39;</span><span class="p">:</span> <span class="n">pmq_manual_patient_query</span><span class="p">,</span>
        <span class="s1">&#39;pmq_final_patient_query&#39;</span><span class="p">:</span> <span class="n">pmq_final_patient_query</span><span class="p">,</span>
        <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="n">warnings</span><span class="p">,</span>
        <span class="s1">&#39;database_structure&#39;</span><span class="p">:</span> <span class="n">get_db_structure_json</span><span class="p">(),</span>
        <span class="s1">&#39;starting_values&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">starting_values_dict</span><span class="p">),</span>
        <span class="s1">&#39;sql_dialect&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_DIALECT</span><span class="p">,</span>
        <span class="s1">&#39;dialect_mysql&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_DIALECT</span> <span class="o">==</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MYSQL</span><span class="p">,</span>
        <span class="s1">&#39;dialect_mssql&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">RESEARCH_DB_DIALECT</span> <span class="o">==</span> <span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MSSQL</span><span class="p">,</span>
        <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
        <span class="s1">&#39;manual_form&#39;</span><span class="p">:</span> <span class="n">manual_form</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;pe_build.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_choose</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">all_pes</span> <span class="o">=</span> <span class="n">get_all_pes</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">patient_explorers</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">all_pes</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;nav_on_pe_choose&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;patient_explorers&#39;</span><span class="p">:</span> <span class="n">patient_explorers</span><span class="p">,</span>
        <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;pe_choose.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_activate</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">validate_blank_form</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="n">pe</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;pe_choose&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_delete</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">validate_blank_form</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="n">pe</span><span class="o">.</span><span class="n">delete_if_permitted</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;pe_choose&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_edit</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">validate_blank_form</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">patient_multiquery_scratchpad</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">patient_multiquery</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;pe_build&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_results</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="n">grammar</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">grammar</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">highlights</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">get_active_highlights</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">highlight_dict</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">as_ordered_dict</span><span class="p">(</span><span class="n">highlights</span><span class="p">)</span>
    <span class="n">element_counter</span> <span class="o">=</span> <span class="n">HtmlElementCounter</span><span class="p">()</span>
    <span class="n">patient_id_query_html</span> <span class="o">=</span> <span class="n">prettify_sql_html</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">get_patient_id_query</span><span class="p">())</span>
    <span class="n">patients_per_page</span> <span class="o">=</span> <span class="n">get_patients_per_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mrids</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_patient_mrids</span><span class="p">()</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mrids</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">patients_per_page</span><span class="p">)</span>
        <span class="n">active_mrids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">active_mrids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">table_id</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">pe</span><span class="o">.</span><span class="n">all_queries</span><span class="p">(</span><span class="n">mrids</span><span class="o">=</span><span class="n">active_mrids</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_executed_cursor</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">get_fieldnames_from_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="n">table_html</span> <span class="o">=</span> <span class="n">resultset_html_table</span><span class="p">(</span>
                        <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">,</span>
                        <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
                        <span class="n">element_counter</span><span class="o">=</span><span class="n">element_counter</span><span class="p">,</span>
                        <span class="n">highlight_dict</span><span class="o">=</span><span class="n">highlight_dict</span><span class="p">,</span>
                        <span class="n">collapse_at_len</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_len</span><span class="p">,</span>
                        <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
                        <span class="n">line_length</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">line_length</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">query_html</span> <span class="o">=</span> <span class="n">element_counter</span><span class="o">.</span><span class="n">visibility_div_with_divbutton</span><span class="p">(</span>
                        <span class="n">contents</span><span class="o">=</span><span class="n">prettify_sql_and_args</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
                        <span class="n">title_html</span><span class="o">=</span><span class="s2">&quot;SQL&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">table_id</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">),</span>
                        <span class="s1">&#39;table_html&#39;</span><span class="p">:</span> <span class="n">table_html</span><span class="p">,</span>
                        <span class="s1">&#39;query_html&#39;</span><span class="p">:</span> <span class="n">query_html</span><span class="p">,</span>
                    <span class="p">})</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nav_on_pe_results&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
            <span class="s1">&#39;rowcount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">mrids</span><span class="p">),</span>
            <span class="s1">&#39;patient_id_query_html&#39;</span><span class="p">:</span> <span class="n">patient_id_query_html</span><span class="p">,</span>
            <span class="s1">&#39;patients_per_page&#39;</span><span class="p">:</span> <span class="n">patients_per_page</span><span class="p">,</span>
            <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;pe_result.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_pe</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">render_missing_pe</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;pe_missing.html&#39;</span><span class="p">,</span> <span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>


<span class="c1"># noinspection PyUnusedLocal</span>
<span class="k">def</span> <span class="nf">render_bad_pe</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                  <span class="n">pe</span><span class="p">:</span> <span class="n">PatientExplorer</span><span class="p">,</span>
                  <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">recover_info_from_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
    <span class="n">final_sql</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sql&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;exception&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">exception</span><span class="p">),</span>
        <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">prettify_sql_and_args</span><span class="p">(</span><span class="n">final_sql</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
        <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;pe_bad.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="c1"># def render_bad_pe_id(request: HttpRequest, pe_id: int) -&gt; HttpResponse:</span>
<span class="c1">#     context = {&#39;pe_id&#39;: pe_id}</span>
<span class="c1">#     context.update(query_context(request))</span>
<span class="c1">#     return render(request, &#39;pe_bad_id.html&#39;, context)</span>


<span class="k">def</span> <span class="nf">get_all_pes</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">PatientExplorer</span><span class="o">.</span><span class="n">objects</span>\
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">deleted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-active&#39;</span><span class="p">,</span> <span class="s1">&#39;-created&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_identical_pes</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
                      <span class="n">pmq</span><span class="p">:</span> <span class="n">PatientMultiQuery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PatientMultiQuery</span><span class="p">]:</span>
    <span class="n">all_pes</span> <span class="o">=</span> <span class="n">get_all_pes</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c1"># identical_pes = all_pes.filter(patient_multiquery=pmq)</span>
    <span class="c1">#</span>
    <span class="c1"># ... this works, but does so by converting the parameter (pmq) to its</span>
    <span class="c1"># JSON representation, presumably via JsonClassField.get_prep_value().</span>
    <span class="c1"># Accordingly, we can predict problems under SQL Server with very long</span>
    <span class="c1"># strings; see the problem in query_submit().</span>
    <span class="c1"># So, we should similarly hash:</span>
    <span class="n">identical_pes</span> <span class="o">=</span> <span class="n">all_pes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pmq_hash</span><span class="o">=</span><span class="n">pmq</span><span class="o">.</span><span class="n">hash64</span><span class="p">)</span>
    <span class="c1"># Beware: Python&#39;s hash() function will downconvert to 32 bits on 32-bit</span>
    <span class="c1"># machines; use pmq.hash64() directly, not hash(pmq).</span>

    <span class="c1"># Double-check in Python in case of hash collision:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">pe</span> <span class="k">for</span> <span class="n">pe</span> <span class="ow">in</span> <span class="n">identical_pes</span> <span class="k">if</span> <span class="n">pe</span><span class="o">.</span><span class="n">patient_multiquery</span> <span class="o">==</span> <span class="n">pmq</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">pe_submit</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span>
              <span class="n">pmq</span><span class="p">:</span> <span class="n">PatientMultiQuery</span><span class="p">,</span>
              <span class="n">run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">identical_pes</span> <span class="o">=</span> <span class="n">get_identical_pes</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pmq</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">identical_pes</span><span class="p">:</span>
        <span class="n">identical_pes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
        <span class="n">pe_id</span> <span class="o">=</span> <span class="n">identical_pes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">PatientExplorer</span><span class="p">(</span><span class="n">patient_multiquery</span><span class="o">=</span><span class="n">pmq</span><span class="p">,</span>
                             <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                             <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pe</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">pe_id</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">id</span>
    <span class="c1"># log.critical(pprint.pformat(connection.queries))  # show all queries</span>
    <span class="c1"># redirect to a new URL:</span>
    <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;pe_results&#39;</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;pe_choose&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_tsv_zip</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="c1"># http://stackoverflow.com/questions/12881294/django-create-a-zip-of-multiple-files-and-make-it-downloadable  # noqa</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">file_response</span><span class="p">(</span>
            <span class="n">pe</span><span class="o">.</span><span class="n">get_zipped_tsv_binary</span><span class="p">(),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">ZIP</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;crate_pe_</span><span class="si">{num}</span><span class="s2">_</span><span class="si">{datetime}</span><span class="s2">.zip&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">num</span><span class="o">=</span><span class="n">pe</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">datetime</span><span class="o">=</span><span class="n">datetime_iso_for_filename</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_pe</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_excel</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">file_response</span><span class="p">(</span>
            <span class="n">pe</span><span class="o">.</span><span class="n">get_xlsx_binary</span><span class="p">(),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">XLSX</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;crate_pe_</span><span class="si">{num}</span><span class="s2">_</span><span class="si">{datetime}</span><span class="s2">.xlsx&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">num</span><span class="o">=</span><span class="n">pe</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">datetime</span><span class="o">=</span><span class="n">datetime_iso_for_filename</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_pe</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_data_finder_results</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">patients_per_page</span> <span class="o">=</span> <span class="n">get_patients_per_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">element_counter</span> <span class="o">=</span> <span class="n">HtmlElementCounter</span><span class="p">()</span>
    <span class="n">patient_id_query_html</span> <span class="o">=</span> <span class="n">prettify_sql_html</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">get_patient_id_query</span><span class="p">())</span>
    <span class="c1"># If this query is done as a UNION, it&#39;s massive, e.g. ~410 characters</span>
    <span class="c1"># * number of tables (e.g. 1448 in one RiO database), for 0.5 Mb of query.</span>
    <span class="c1"># So do it more sensibly:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mrids</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_patient_mrids</span><span class="p">()</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mrids</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">patients_per_page</span><span class="p">)</span>
        <span class="n">active_mrids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">results_table_html</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">query_html</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">active_mrids</span><span class="p">:</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">table_identifier</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> \
                    <span class="n">pe</span><span class="o">.</span><span class="n">patient_multiquery</span><span class="o">.</span><span class="n">gen_data_finder_queries</span><span class="p">(</span>
                        <span class="n">mrids</span><span class="o">=</span><span class="n">active_mrids</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_executed_cursor</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldnames</span><span class="p">:</span>
                        <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">get_fieldnames_from_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="n">query_html</span> <span class="o">+=</span> <span class="n">element_counter</span><span class="o">.</span><span class="n">visibility_div_with_divbutton</span><span class="p">(</span>  <span class="c1"># noqa</span>
                        <span class="n">contents</span><span class="o">=</span><span class="n">prettify_sql_and_args</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
                        <span class="n">title_html</span><span class="o">=</span><span class="s2">&quot;SQL for &quot;</span> <span class="o">+</span> <span class="n">table_identifier</span><span class="p">)</span>
            <span class="n">results_table_html</span> <span class="o">=</span> <span class="n">resultset_html_table</span><span class="p">(</span>
                <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">,</span>
                <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
                <span class="n">element_counter</span><span class="o">=</span><span class="n">element_counter</span><span class="p">,</span>
                <span class="n">collapse_at_len</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_len</span><span class="p">,</span>
                <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
                <span class="n">line_length</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">line_length</span><span class="p">,</span>
                <span class="n">no_ditto_cols</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                <span class="n">null</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nav_on_pe_df_results&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;some_patients&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_mrids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;results_table_html&#39;</span><span class="p">:</span> <span class="n">results_table_html</span><span class="p">,</span>
            <span class="s1">&#39;query_html&#39;</span><span class="p">:</span> <span class="n">query_html</span><span class="p">,</span>
            <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
            <span class="s1">&#39;rowcount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">mrids</span><span class="p">),</span>
            <span class="s1">&#39;patient_id_query_html&#39;</span><span class="p">:</span> <span class="n">patient_id_query_html</span><span class="p">,</span>
            <span class="s1">&#39;patients_per_page&#39;</span><span class="p">:</span> <span class="n">patients_per_page</span><span class="p">,</span>
            <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;pe_df_result.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_pe</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_data_finder_excel</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">file_response</span><span class="p">(</span>
            <span class="n">pe</span><span class="o">.</span><span class="n">data_finder_excel</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">XLSX</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;crate_pe_df_</span><span class="si">{num}</span><span class="s2">_</span><span class="si">{datetime}</span><span class="s2">.xlsx&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">num</span><span class="o">=</span><span class="n">pe</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">datetime</span><span class="o">=</span><span class="n">datetime_iso_for_filename</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_pe</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_monster_results</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="n">grammar</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">grammar</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">highlights</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">get_active_highlights</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">highlight_dict</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">as_ordered_dict</span><span class="p">(</span><span class="n">highlights</span><span class="p">)</span>
    <span class="n">element_counter</span> <span class="o">=</span> <span class="n">HtmlElementCounter</span><span class="p">()</span>
    <span class="n">patient_id_query_html</span> <span class="o">=</span> <span class="n">prettify_sql_html</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">get_patient_id_query</span><span class="p">())</span>
    <span class="n">patients_per_page</span> <span class="o">=</span> <span class="n">get_patients_per_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rids</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_patient_mrids</span><span class="p">()</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">rids</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">patients_per_page</span><span class="p">)</span>
        <span class="n">active_rids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pmq</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">patient_multiquery</span>
        <span class="k">if</span> <span class="n">active_rids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">table_id</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">pmq</span><span class="o">.</span><span class="n">gen_monster_queries</span><span class="p">(</span><span class="n">mrids</span><span class="o">=</span><span class="n">active_rids</span><span class="p">):</span>  <span class="c1"># noqa</span>
                <span class="k">with</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_executed_cursor</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">get_fieldnames_from_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
                        <span class="n">table_html</span> <span class="o">=</span> <span class="n">resultset_html_table</span><span class="p">(</span>
                            <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">,</span>
                            <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
                            <span class="n">element_counter</span><span class="o">=</span><span class="n">element_counter</span><span class="p">,</span>
                            <span class="n">highlight_dict</span><span class="o">=</span><span class="n">highlight_dict</span><span class="p">,</span>
                            <span class="n">collapse_at_len</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_len</span><span class="p">,</span>
                            <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
                            <span class="n">line_length</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">line_length</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">table_html</span> <span class="o">=</span> <span class="s2">&quot;&lt;div&gt;&lt;i&gt;No data&lt;/i&gt;&lt;/div&gt;&quot;</span>
                    <span class="n">query_html</span> <span class="o">=</span> <span class="n">element_counter</span><span class="o">.</span><span class="n">visibility_div_with_divbutton</span><span class="p">(</span>
                        <span class="n">contents</span><span class="o">=</span><span class="n">prettify_sql_and_args</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span>
                        <span class="n">title_html</span><span class="o">=</span><span class="s2">&quot;SQL&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;tablename&#39;</span><span class="p">:</span> <span class="n">table_id</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">),</span>
                        <span class="s1">&#39;table_html&#39;</span><span class="p">:</span> <span class="n">table_html</span><span class="p">,</span>
                        <span class="s1">&#39;query_html&#39;</span><span class="p">:</span> <span class="n">query_html</span><span class="p">,</span>
                    <span class="p">})</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nav_on_pe_monster_results&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
            <span class="s1">&#39;rowcount&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rids</span><span class="p">),</span>
            <span class="s1">&#39;patient_id_query_html&#39;</span><span class="p">:</span> <span class="n">patient_id_query_html</span><span class="p">,</span>
            <span class="s1">&#39;patients_per_page&#39;</span><span class="p">:</span> <span class="n">patients_per_page</span><span class="p">,</span>
            <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;pe_monster_result.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_pe</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_table_browser</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_tables</span><span class="p">()</span>
    <span class="n">with_database</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">uses_database_level</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nav_on_pe_table_browser&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;pe_id&#39;</span><span class="p">:</span> <span class="n">pe_id</span><span class="p">,</span>
            <span class="s1">&#39;tables&#39;</span><span class="p">:</span> <span class="n">tables</span><span class="p">,</span>
            <span class="s1">&#39;with_database&#39;</span><span class="p">:</span> <span class="n">with_database</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;pe_table_browser.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_pe</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pe_one_table</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">pe_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">PatientExplorer</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">pe_id</span><span class="p">)</span>  <span class="c1"># type: PatientExplorer</span>
    <span class="n">table_id</span> <span class="o">=</span> <span class="n">TableId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
    <span class="n">grammar</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">grammar</span>
    <span class="n">highlights</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">get_active_highlights</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">highlight_dict</span> <span class="o">=</span> <span class="n">Highlight</span><span class="o">.</span><span class="n">as_ordered_dict</span><span class="p">(</span><span class="n">highlights</span><span class="p">)</span>
    <span class="n">element_counter</span> <span class="o">=</span> <span class="n">HtmlElementCounter</span><span class="p">()</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">patients_per_page</span> <span class="o">=</span> <span class="n">get_patients_per_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mrids</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_patient_mrids</span><span class="p">()</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mrids</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">patients_per_page</span><span class="p">)</span>
        <span class="n">active_mrids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">table_html</span> <span class="o">=</span> <span class="s2">&quot;&lt;div&gt;&lt;i&gt;No data&lt;/i&gt;&lt;/div&gt;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rowcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">active_mrids</span><span class="p">:</span>
            <span class="n">mrid_column</span> <span class="o">=</span> <span class="n">research_database_info</span><span class="o">.</span><span class="n">get_mrid_column_from_table</span><span class="p">(</span>
                <span class="n">table_id</span><span class="p">)</span>
            <span class="n">where_clause</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{mrid}</span><span class="s2"> IN (</span><span class="si">{in_clause}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">mrid</span><span class="o">=</span><span class="n">mrid_column</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">),</span>
                <span class="n">in_clause</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;?&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_mrids</span><span class="p">)),</span>
            <span class="p">)</span>  <span class="c1"># ... see notes for translate_sql_qmark_to_percent()</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">active_mrids</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="n">add_to_select</span><span class="p">(</span>
                <span class="n">sql</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">select_elements</span><span class="o">=</span><span class="p">[</span><span class="n">SelectElement</span><span class="p">(</span>
                    <span class="n">raw_select</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                    <span class="n">from_table_for_raw_select</span><span class="o">=</span><span class="n">table_id</span>
                <span class="p">)],</span>
                <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span>
                <span class="n">where_conditions</span><span class="o">=</span><span class="p">[</span><span class="n">WhereCondition</span><span class="p">(</span>
                    <span class="n">raw_sql</span><span class="o">=</span><span class="n">where_clause</span><span class="p">,</span>
                    <span class="n">from_table_for_raw_sql</span><span class="o">=</span><span class="n">mrid_column</span><span class="o">.</span><span class="n">table_id</span>
                <span class="p">)],</span>
                <span class="n">magic_join</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_executed_cursor</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">get_fieldnames_from_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="n">rowcount</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
                <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">table_html</span> <span class="o">=</span> <span class="n">resultset_html_table</span><span class="p">(</span>
                        <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">,</span>
                        <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
                        <span class="n">element_counter</span><span class="o">=</span><span class="n">element_counter</span><span class="p">,</span>
                        <span class="n">highlight_dict</span><span class="o">=</span><span class="n">highlight_dict</span><span class="p">,</span>
                        <span class="n">collapse_at_len</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_len</span><span class="p">,</span>
                        <span class="n">collapse_at_n_lines</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">collapse_at_n_lines</span><span class="p">,</span>
                        <span class="n">line_length</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">line_length</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="c1"># Render</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;table_html&#39;</span><span class="p">:</span> <span class="n">table_html</span><span class="p">,</span>
            <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
            <span class="s1">&#39;rowcount&#39;</span><span class="p">:</span> <span class="n">rowcount</span><span class="p">,</span>
            <span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="n">prettify_sql_and_args</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">),</span>
            <span class="s1">&#39;sql_highlight_css&#39;</span><span class="p">:</span> <span class="n">prettify_sql_css</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query_context</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;query_result.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_bad_pe</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../website_using/index.html">9. Using the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../autodoc/index.html">15. Automatic documentation of source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../misc/to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>