
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crate_anon.anonymise.anonregex &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crate_anon.anonymise.anonregex</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># crate_anon/anonymise/anonregex.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2015-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CRATE.</span>

<span class="sd">    CRATE is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CRATE is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CRATE. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Imports</span>
<span class="c1"># =============================================================================</span>

<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">dateutil.parser</span>  <span class="c1"># for unit tests</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.lists</span> <span class="k">import</span> <span class="n">unique_list</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.logs</span> <span class="k">import</span> <span class="n">configure_logger_for_colour</span>

<span class="c1"># https://pypi.python.org/pypi/regex/</span>
<span class="c1"># https://bitbucket.org/mrabarnett/mrab-regex</span>
<span class="kn">import</span> <span class="nn">regex</span>  <span class="c1"># sudo apt-get install python-regex</span>
<span class="c1"># noinspection PyProtectedMember</span>
<span class="kn">from</span> <span class="nn">regex</span> <span class="k">import</span> <span class="n">_regex_core</span>

<span class="kn">from</span> <span class="nn">crate_anon.common.stringfunc</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_digit_string_from_vaguely_numeric_string</span><span class="p">,</span>  <span class="c1"># for unit testing</span>
    <span class="n">reduce_to_alphanumeric</span><span class="p">,</span>  <span class="c1"># for unit testing</span>
<span class="p">)</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Constants</span>
<span class="c1"># =============================================================================</span>

<span class="n">REGEX_METACHARS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;{&quot;</span><span class="p">]</span>
<span class="c1"># http://www.regular-expressions.info/characters.html</span>
<span class="c1"># Start with \, for replacement.</span>

<span class="n">WB</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\b&quot;</span>  <span class="c1"># word boundary; escape the slash if not using a raw string</span>

<span class="c1"># http://www.regular-expressions.info/lookaround.html</span>
<span class="c1"># Not all engines support lookbehind; e.g. regexr.com doesn&#39;t; but Python does</span>
<span class="n">NOT_DIGIT_LOOKBEHIND</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?&lt;!\d)&quot;</span>
<span class="n">NOT_DIGIT_LOOKAHEAD</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?!\d)&quot;</span>

<span class="c1"># The Kleene star has highest precedence.</span>
<span class="c1"># So, for example, ab*c matches abbbc, but not (all of) ababc. See regexr.com</span>
<span class="n">OPTIONAL_NONWORD</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\W*&quot;</span>  <span class="c1"># zero or more non-alphanumeric characters...</span>
<span class="c1"># ... doesn&#39;t need to be [\W]*, for precedence reasons as above.</span>
<span class="n">AT_LEAST_ONE_NONWORD</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\W+&quot;</span>  <span class="c1"># 1 or more non-alphanumeric character</span>

<span class="n">NON_ALPHANUMERIC_SPLITTERS</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">AT_LEAST_ONE_NONWORD</span><span class="p">,</span> <span class="n">regex</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

<span class="n">OPTIONAL_WHITESPACE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\s*&quot;</span>  <span class="c1"># zero or more whitespace chars</span>
<span class="n">OPTIONAL_NON_NEWLINE_WHITESPACE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[ \t]*&quot;</span>  <span class="c1"># zero or more spaces/tabs</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># String manipulation</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="get_anon_fragments_from_string"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.get_anon_fragments_from_string">[docs]</a><span class="k">def</span> <span class="nf">get_anon_fragments_from_string</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a complex string, such as a name or address with its components</span>
<span class="sd">    separated by spaces, commas, etc., and returns a list of substrings to be</span>
<span class="sd">    used for anonymisation.</span>
<span class="sd">    - For example, from &quot;John Smith&quot;, return [&quot;John&quot;, &quot;Smith&quot;];</span>
<span class="sd">      from &quot;John D&#39;Souza&quot;, return [&quot;John&quot;, &quot;D&quot;, &quot;Souza&quot;];</span>
<span class="sd">      from &quot;42 West Street&quot;, return [&quot;42&quot;, &quot;West&quot;, &quot;Street&quot;].</span>

<span class="sd">    - Try the examples listed below the function.</span>
<span class="sd">    - Note that this is a LIBERAL algorithm, i.e. one prone to anonymise too</span>
<span class="sd">      much (e.g. all instances of &quot;Street&quot; if someone has that as part of their</span>
<span class="sd">      address).</span>
<span class="sd">    - NOTE THAT WE USE THE &quot;WORD BOUNDARY&quot; FACILITY WHEN REPLACING, AND THAT</span>
<span class="sd">      TREATS APOSTROPHES AND HYPHENS AS WORD BOUNDARIES.</span>
<span class="sd">      Therefore, we don&#39;t need the largest-level chunks, like D&#39;Souza.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">NON_ALPHANUMERIC_SPLITTERS</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>
    <span class="c1"># smallfragments = []</span>
    <span class="c1"># combinedsmallfragments = []</span>
    <span class="c1"># for chunk in s.split():  # split on whitespace</span>
    <span class="c1">#     for smallchunk in NON_WHITESPACE_SPLITTERS.split(chunk):</span>
    <span class="c1">#         if smallchunk.lower() in config.words_not_to_scrub:</span>
    <span class="c1">#             continue</span>
    <span class="c1">#         smallfragments.append(smallchunk)</span>
    <span class="c1">#         # OVERLAP here, but we need it for the combination bit, and</span>
    <span class="c1">#         # we remove the overlap at the end.</span>
    <span class="c1"># # Now we have chunks with e.g. apostrophes in, and all chunks split by</span>
    <span class="c1"># # everything. Finally, we want all of these lumped together.</span>
    <span class="c1"># for L in xrange(len(smallfragments) + 1):</span>
    <span class="c1">#     for subset in itertools.combinations(smallfragments, L):</span>
    <span class="c1">#         if subset:</span>
    <span class="c1">#             combinedsmallfragments.append(&quot;&quot;.join(subset))</span>
    <span class="c1"># return list(set(smallfragments + combinedsmallfragments))</span>
<span class="c1"># EXAMPLES:</span>
<span class="c1"># get_anon_fragments_from_string(&quot;Bob D&#39;Souza&quot;)</span>
<span class="c1"># get_anon_fragments_from_string(&quot;Jemima Al-Khalaim&quot;)</span>
<span class="c1"># get_anon_fragments_from_string(&quot;47 Russell Square&quot;)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Regexes</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="escape_literal_string_for_regex"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.escape_literal_string_for_regex">[docs]</a><span class="k">def</span> <span class="nf">escape_literal_string_for_regex</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Escape any regex characters.</span>

<span class="sd">    Start with \ -&gt; \\</span>
<span class="sd">        ... this should be the first replacement in REGEX_METACHARS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">REGEX_METACHARS</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Anonymisation regexes</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Note, for strings, several typo-detecting methods:</span>
<span class="c1">#   http://en.wikipedia.org/wiki/Levenshtein_distance</span>
<span class="c1">#   http://mwh.geek.nz/2009/04/26/python-damerau-levenshtein-distance/</span>
<span class="c1">#   http://en.wikipedia.org/wiki/TRE_(computing)</span>
<span class="c1">#   https://pypi.python.org/pypi/regex</span>
<span class="c1"># ... let&#39;s go with the fuzzy regex method (Python regex module).</span>

<div class="viewcode-block" id="get_date_regex_elements"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.get_date_regex_elements">[docs]</a><span class="k">def</span> <span class="nf">get_date_regex_elements</span><span class="p">(</span>
        <span class="n">dt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">],</span>
        <span class="n">at_word_boundaries_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a datetime object and returns a list of regex strings with which</span>
<span class="sd">    to scrub.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Reminders: ? zero or one, + one or more, * zero or more</span>
    <span class="c1"># Non-capturing groups: (?:...)</span>
    <span class="c1"># ... https://docs.python.org/2/howto/regex.html</span>
    <span class="c1"># ... http://stackoverflow.com/questions/3512471/non-capturing-group</span>
    <span class="c1"># Day, allowing leading zeroes and e.g. &quot;1st, 2nd&quot;</span>
    <span class="n">day</span> <span class="o">=</span> <span class="s2">&quot;0*&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;(?:st|nd|rd|th)?&quot;</span>
    <span class="c1"># Month, allowing leading zeroes for numeric and e.g. Feb/February</span>
    <span class="n">month_numeric</span> <span class="o">=</span> <span class="s2">&quot;0*&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
    <span class="c1"># month_word = dt.strftime(&quot;%B&quot;)  # can&#39;t cope with years &lt; 1900</span>
    <span class="n">month_word</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_name</span><span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">]</span>
    <span class="n">month_word</span> <span class="o">=</span> <span class="n">month_word</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;(?:&quot;</span> <span class="o">+</span> <span class="n">month_word</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;)?&quot;</span>
    <span class="n">month</span> <span class="o">=</span> <span class="s2">&quot;(?:&quot;</span> <span class="o">+</span> <span class="n">month_numeric</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">month_word</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="c1"># Year</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">year</span> <span class="o">=</span> <span class="s2">&quot;(?:&quot;</span> <span class="o">+</span> <span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)?&quot;</span> <span class="o">+</span> <span class="n">year</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="c1"># ... converts e.g. 1986 to (19)?86, to match 1986 or 86</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="n">OPTIONAL_NONWORD</span>
    <span class="c1"># Regexes</span>
    <span class="n">basic_regexes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">day</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">month</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">year</span><span class="p">,</span>  <span class="c1"># e.g. 13 Sep 2014</span>
        <span class="n">month</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">day</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">year</span><span class="p">,</span>  <span class="c1"># e.g. Sep 13, 2014</span>
        <span class="n">year</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">month</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">day</span><span class="p">,</span>  <span class="c1"># e.g. 2014/09/13</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">at_word_boundaries_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">WB</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">WB</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">basic_regexes</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">basic_regexes</span></div>


<div class="viewcode-block" id="get_code_regex_elements"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.get_code_regex_elements">[docs]</a><span class="k">def</span> <span class="nf">get_code_regex_elements</span><span class="p">(</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">liberal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">very_liberal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">at_word_boundaries_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">at_numeric_boundaries_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a STRING representation of a number or an alphanumeric code, which</span>
<span class="sd">    may include leading zeros (as for phone numbers), and produces a list of</span>
<span class="sd">    regex strings for scrubbing.</span>

<span class="sd">    We allow all sorts of separators. For example, 0123456789 might appear as</span>
<span class="sd">        (01234) 56789</span>
<span class="sd">        0123 456 789</span>
<span class="sd">        01234-56789</span>
<span class="sd">        0123.456.789</span>

<span class="sd">    This can also be used for postcodes, which should have whitespace</span>
<span class="sd">    prestripped, so e.g. PE123AB might appear as</span>
<span class="sd">        PE123AB</span>
<span class="sd">        PE12 3AB</span>
<span class="sd">        PE 12 3 AB</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">escape_literal_string_for_regex</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># escape any decimal points, etc.</span>
    <span class="k">if</span> <span class="n">very_liberal</span><span class="p">:</span>
        <span class="n">separators</span> <span class="o">=</span> <span class="n">OPTIONAL_NONWORD</span>
    <span class="k">elif</span> <span class="n">liberal</span><span class="p">:</span>
        <span class="n">separators</span> <span class="o">=</span> <span class="n">OPTIONAL_NON_NEWLINE_WHITESPACE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">separators</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">separators</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">])</span>  <span class="c1"># ... can appear anywhere</span>
    <span class="k">if</span> <span class="n">at_word_boundaries_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">WB</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="n">WB</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">at_numeric_boundaries_only</span><span class="p">:</span>
            <span class="c1"># Even though we&#39;re not restricting to word boundaries, because</span>
            <span class="c1"># (for example) we want 123456 to match &quot;M123456&quot;, it can be</span>
            <span class="c1"># undesirable match numbers that are bordered only by numbers; that</span>
            <span class="c1"># is, with this setting, &quot;23&quot; should never match &quot;234&quot; or &quot;1234&quot;</span>
            <span class="c1"># or &quot;123&quot;.</span>
            <span class="c1"># - http://www.regular-expressions.info/lookaround.html</span>
            <span class="c1"># - http://stackoverflow.com/questions/15099150/regex-find-one-digit-number  # noqa</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">NOT_DIGIT_LOOKBEHIND</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="n">NOT_DIGIT_LOOKAHEAD</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># But if you want to anonymise &quot;123456&quot; out of a phone number</span>
            <span class="c1"># written like &quot;01223123456&quot;, you might have to turn that off...</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_number_of_length_n_regex_elements"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.get_number_of_length_n_regex_elements">[docs]</a><span class="k">def</span> <span class="nf">get_number_of_length_n_regex_elements</span><span class="p">(</span>
        <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">liberal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">very_liberal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">at_word_boundaries_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a list of regex strings for scrubbing n-digit numbers -- for</span>
<span class="sd">    example, to remove all 10-digit numbers as putative NHS numbers, or all</span>
<span class="sd">    11-digit numbers as putative UK phone numbers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;[0-9]&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
    <span class="k">if</span> <span class="n">very_liberal</span><span class="p">:</span>
        <span class="n">separators</span> <span class="o">=</span> <span class="n">OPTIONAL_NONWORD</span>
    <span class="k">elif</span> <span class="n">liberal</span><span class="p">:</span>
        <span class="n">separators</span> <span class="o">=</span> <span class="n">OPTIONAL_NON_NEWLINE_WHITESPACE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">separators</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">separators</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">at_word_boundaries_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">WB</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="n">WB</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">NOT_DIGIT_LOOKBEHIND</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="n">NOT_DIGIT_LOOKAHEAD</span><span class="p">]</span></div>
        <span class="c1"># ... if there was a digit before/after, it&#39;s not an n-digit number</span>


<div class="viewcode-block" id="get_uk_postcode_regex_elements"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.get_uk_postcode_regex_elements">[docs]</a><span class="k">def</span> <span class="nf">get_uk_postcode_regex_elements</span><span class="p">(</span>
        <span class="n">at_word_boundaries_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a list of regex strings for scrubbing UK postcodes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;AN NAA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ANN NAA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AAN NAA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AANN NAA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ANA NAA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AANA NAA&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)):</span>
        <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;[A-Z]&quot;</span><span class="p">)</span>  <span class="c1"># letter</span>
        <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;[0-9]&quot;</span><span class="p">)</span>  <span class="c1"># number</span>
        <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">OPTIONAL_WHITESPACE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">at_word_boundaries_only</span><span class="p">:</span>
            <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">WB</span> <span class="o">+</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">WB</span>
    <span class="k">return</span> <span class="n">e</span></div>


<div class="viewcode-block" id="get_string_regex_elements"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.get_string_regex_elements">[docs]</a><span class="k">def</span> <span class="nf">get_string_regex_elements</span><span class="p">(</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">suffixes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">at_word_boundaries_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_errors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a string and returns a list of regex strings with which to scrub.</span>
<span class="sd">    Options:</span>
<span class="sd">    - list of suffixes to permit, typically [&quot;s&quot;]</span>
<span class="sd">    - typographical errors</span>
<span class="sd">    - whether to constrain to word boundaries or not</span>
<span class="sd">        ... if false: will scrub ANN from bANNed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">escape_literal_string_for_regex</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_errors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;){e&lt;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_errors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="c1"># - a leading (?e) forces a search for a better match than the first;</span>
        <span class="c1">#   the other way is to specify the regex.ENHANCEMATCH flag...</span>
        <span class="c1">#   however, when doing this in get_regex_from_elements(), we got a</span>
        <span class="c1">#   segmentation fault... and, less consistently, when we put it here.</span>
        <span class="c1">#   So skip that!</span>
        <span class="c1"># - (...) is the pattern</span>
        <span class="c1"># - suffix up to n insertion/deletion/substitution errors</span>
        <span class="c1"># ... https://pypi.python.org/pypi/regex</span>
        <span class="c1"># ... http://www.gossamer-threads.com/lists/python/python/1002881</span>
    <span class="k">if</span> <span class="n">suffixes</span><span class="p">:</span>
        <span class="n">suffixstr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;(?:&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">escape_literal_string_for_regex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">])</span> <span class="o">+</span>
            <span class="s2">&quot;|)&quot;</span>  <span class="c1"># allows for no suffix at all</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">suffixstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">at_word_boundaries_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">WB</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="n">suffixstr</span> <span class="o">+</span> <span class="n">WB</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="n">suffixstr</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_phrase_regex_elements"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.get_phrase_regex_elements">[docs]</a><span class="k">def</span> <span class="nf">get_phrase_regex_elements</span><span class="p">(</span>
        <span class="n">phrase</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">at_word_boundaries_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_errors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    phrase: e.g. &#39;4 Privet Drive&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strings</span> <span class="o">=</span> <span class="n">get_anon_fragments_from_string</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">strings</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">escape_literal_string_for_regex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">AT_LEAST_ONE_NONWORD</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_errors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;){e&lt;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_errors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
    <span class="k">if</span> <span class="n">at_word_boundaries_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">WB</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="n">WB</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Combining regex elements into a giant regex</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="get_regex_string_from_elements"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.get_regex_string_from_elements">[docs]</a><span class="k">def</span> <span class="nf">get_regex_string_from_elements</span><span class="p">(</span><span class="n">elementlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of regex elements into a single regex string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">elementlist</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">u</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_list</span><span class="p">(</span><span class="n">elementlist</span><span class="p">))</span></div>
    <span class="c1"># The or operator | has the lowest precedence.</span>
    <span class="c1"># ... http://www.regular-expressions.info/alternation.html</span>
    <span class="c1"># We also want to minimize the number of brackets.</span>
    <span class="c1"># THEREFORE, ANYTHING CONTRIBUTING FRAGMENTS HERE SHOULD NOT HAVE |</span>
    <span class="c1"># OPERATORS AT ITS TOP LEVEL. If it does, it should encapsulate them in a</span>
    <span class="c1"># non-capturing group, (?:...)</span>


<div class="viewcode-block" id="get_regex_from_elements"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.get_regex_from_elements">[docs]</a><span class="k">def</span> <span class="nf">get_regex_from_elements</span><span class="p">(</span><span class="n">elementlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Pattern</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of regex elements into a compiled regex, which will operate</span>
<span class="sd">    in case-insensitive fashion on Unicode strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">elementlist</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">get_regex_string_from_elements</span><span class="p">(</span><span class="n">elementlist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">regex</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">regex</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">regex</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">_regex_core</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed regex: elementlist=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elementlist</span><span class="p">))</span>
        <span class="k">raise</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Unit tests</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="TestAnonRegexes"><a class="viewcode-back" href="../../../autodoc/anonymise/anonregex.html#crate_anon.anonymise.anonregex.TestAnonRegexes">[docs]</a><span class="k">class</span> <span class="nc">TestAnonRegexes</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">STRING_1</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        I was born on 07 Jan 2013, m&#39;lud.</span>
<span class="s2">        It was 7 January 13, or 7/1/13, or 1/7/13, or</span>
<span class="s2">        Jan 7 2013, or 2013/01/07, or 2013-01-07,</span>
<span class="s2">        or 7th January</span>
<span class="s2">        13 (split over a line)</span>
<span class="s2">        or Jan 7th 13</span>
<span class="s2">        or 07.01.13 or 7.1.2013</span>
<span class="s2">        or a host of other variations.</span>
<span class="s2">        And ISO-8601 formats like 20130107T0123, or just 20130107.</span>

<span class="s2">        BUT NOT 8 Jan 2013, or 2013/02/07, or 2013</span>
<span class="s2">        Jan 17, or just a number like 7, or a month</span>
<span class="s2">        like January, or a nonspecific date like</span>
<span class="s2">        Jan 2013 or 7 January. And not ISO-8601-formatted other dates</span>
<span class="s2">        like 20130108T0123, or just 20130108.</span>

<span class="s2">        I am 34 years old. My mother was 348, or 834, or perhaps 8348.</span>
<span class="s2">        Was she 34.6? Don&#39;t think so.</span>

<span class="s2">        Her IDs include NHS#123456, or 123 456, or (123) 456, or 123456.</span>

<span class="s2">        I am 34 years old. My mother was 348, or 834, or perhaps 8348.</span>
<span class="s2">        She wasn&#39;t my step-mother, or my grandmother, or my mother-in-law.</span>
<span class="s2">        She was my MOTHER!</span>
<span class="s2">        A typo is mther.</span>

<span class="s2">        Unicode apostrophe: the threadâ€™s possession</span>

<span class="s2">        E-mail: bob@pobox.com, mr.jones@somewhere.nhs.uk, blah@place.com</span>
<span class="s2">        Mr.Jones@somewhere.nhs.uk</span>

<span class="s2">        Some numbers by size:</span>
<span class="s2">            1</span>
<span class="s2">            12</span>
<span class="s2">            123</span>
<span class="s2">            1234</span>
<span class="s2">            12345</span>
<span class="s2">            123456</span>
<span class="s2">            1234567</span>
<span class="s2">            12345678</span>
<span class="s2">            123456789</span>
<span class="s2">            1234567890</span>
<span class="s2">            12345678901</span>
<span class="s2">            123456789012</span>
<span class="s2">            1234567890123</span>
<span class="s2">            12345678901234</span>
<span class="s2">            123456789012345</span>
<span class="s2">        Some postcodes (from https://www.mrs.org.uk/pdf/postcodeformat.pdf)</span>
<span class="s2">            M1 1AA</span>
<span class="s2">            M60 1NW</span>
<span class="s2">            CR2 6XH</span>
<span class="s2">            DN55 1PT</span>
<span class="s2">            W1A 1HQ</span>
<span class="s2">            EC1A 1BB</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">79</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">79</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_most</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STRING_1</span>
        <span class="n">testnumber</span> <span class="o">=</span> <span class="mi">34</span>
        <span class="n">testnumber_as_text</span> <span class="o">=</span> <span class="s2">&quot;123456&quot;</span>
        <span class="n">testdate_str</span> <span class="o">=</span> <span class="s2">&quot;7 Jan 2013&quot;</span>
        <span class="n">testdate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">testdate_str</span><span class="p">)</span>
        <span class="n">teststring</span> <span class="o">=</span> <span class="s2">&quot;mother&quot;</span>
        <span class="n">testphrase</span> <span class="o">=</span> <span class="s2">&quot;348 or 834&quot;</span>
        <span class="n">date_19th_c</span> <span class="o">=</span> <span class="s2">&quot;3 Sep 1847&quot;</span>
        <span class="n">old_testdate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_19th_c</span><span class="p">)</span>
        <span class="n">testemail</span> <span class="o">=</span> <span class="s2">&quot;mr.jones@somewhere.nhs.uk&quot;</span>

        <span class="n">regex_date</span> <span class="o">=</span> <span class="n">get_regex_from_elements</span><span class="p">(</span><span class="n">get_date_regex_elements</span><span class="p">(</span><span class="n">testdate</span><span class="p">))</span>
        <span class="n">regex_number</span> <span class="o">=</span> <span class="n">get_regex_from_elements</span><span class="p">(</span>
            <span class="n">get_code_regex_elements</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">testnumber</span><span class="p">)))</span>
        <span class="n">regex_number_as_text</span> <span class="o">=</span> <span class="n">get_regex_from_elements</span><span class="p">(</span>
            <span class="n">get_code_regex_elements</span><span class="p">(</span>
                <span class="n">get_digit_string_from_vaguely_numeric_string</span><span class="p">(</span>
                    <span class="n">testnumber_as_text</span><span class="p">)))</span>
        <span class="n">regex_string</span> <span class="o">=</span> <span class="n">get_regex_from_elements</span><span class="p">(</span>
            <span class="n">get_string_regex_elements</span><span class="p">(</span><span class="n">teststring</span><span class="p">))</span>
        <span class="n">regex_email</span> <span class="o">=</span> <span class="n">get_regex_from_elements</span><span class="p">(</span>
            <span class="n">get_string_regex_elements</span><span class="p">(</span><span class="n">testemail</span><span class="p">))</span>
        <span class="n">regex_phrase</span> <span class="o">=</span> <span class="n">get_regex_from_elements</span><span class="p">(</span>
            <span class="n">get_phrase_regex_elements</span><span class="p">(</span><span class="n">testphrase</span><span class="p">))</span>
        <span class="n">regex_10digit</span> <span class="o">=</span> <span class="n">get_regex_from_elements</span><span class="p">(</span>
            <span class="n">get_number_of_length_n_regex_elements</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">regex_postcode</span> <span class="o">=</span> <span class="n">get_regex_from_elements</span><span class="p">(</span>
            <span class="n">get_uk_postcode_regex_elements</span><span class="p">())</span>
        <span class="n">all_elements</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">get_date_regex_elements</span><span class="p">(</span><span class="n">testdate</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">get_code_regex_elements</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">testnumber</span><span class="p">))</span> <span class="o">+</span>
            <span class="n">get_code_regex_elements</span><span class="p">(</span>
                <span class="n">get_digit_string_from_vaguely_numeric_string</span><span class="p">(</span>
                    <span class="n">testnumber_as_text</span><span class="p">))</span> <span class="o">+</span>
            <span class="n">get_string_regex_elements</span><span class="p">(</span><span class="n">teststring</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">get_string_regex_elements</span><span class="p">(</span><span class="n">testemail</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">get_phrase_regex_elements</span><span class="p">(</span><span class="n">testphrase</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">get_number_of_length_n_regex_elements</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">get_uk_postcode_regex_elements</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">regex_all</span> <span class="o">=</span> <span class="n">get_regex_from_elements</span><span class="p">(</span><span class="n">all_elements</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Removing date: &quot;</span> <span class="o">+</span> <span class="n">testdate_str</span><span class="p">,</span>
                    <span class="n">regex_date</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;DATE_GONE&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Removing number: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testnumber</span><span class="p">),</span>
                    <span class="n">regex_number</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;NUMBER_GONE&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Removing numbers as text: &quot;</span> <span class="o">+</span> <span class="n">testnumber_as_text</span><span class="p">,</span>
                    <span class="n">regex_number_as_text</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;NUMBER_AS_TEXT_GONE&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Removing string: &quot;</span> <span class="o">+</span> <span class="n">teststring</span><span class="p">,</span>
                    <span class="n">regex_string</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;STRING_GONE&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Removing email: &quot;</span> <span class="o">+</span> <span class="n">testemail</span><span class="p">,</span>
                    <span class="n">regex_email</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;EMAIL_GONE&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Removing phrase: &quot;</span> <span class="o">+</span> <span class="n">testphrase</span><span class="p">,</span>
                    <span class="n">regex_phrase</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;PHRASE_GONE&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Removing 10-digit numbers&quot;</span><span class="p">,</span>
                    <span class="n">regex_10digit</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;TEN_DIGIT_NUMBERS_GONE&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Removing postcodes&quot;</span><span class="p">,</span>
                    <span class="n">regex_postcode</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;POSTCODES_GONE&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Removing everything&quot;</span><span class="p">,</span> <span class="n">regex_all</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;EVERYTHING_GONE&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;All-elements regex&quot;</span><span class="p">,</span>
                    <span class="n">get_regex_string_from_elements</span><span class="p">(</span><span class="n">all_elements</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Date regex&quot;</span><span class="p">,</span>
                    <span class="n">get_regex_string_from_elements</span><span class="p">(</span>
                        <span class="n">get_date_regex_elements</span><span class="p">(</span><span class="n">testdate</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Date regex for 19th century&quot;</span><span class="p">,</span>
                    <span class="n">get_regex_string_from_elements</span><span class="p">(</span>
                        <span class="n">get_date_regex_elements</span><span class="p">(</span><span class="n">old_testdate</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Phrase regex&quot;</span><span class="p">,</span> <span class="n">get_regex_string_from_elements</span><span class="p">(</span>
            <span class="n">get_phrase_regex_elements</span><span class="p">(</span><span class="n">testphrase</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;10-digit-number regex&quot;</span><span class="p">,</span> <span class="n">get_regex_string_from_elements</span><span class="p">(</span>
            <span class="n">get_number_of_length_n_regex_elements</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span></div>


<span class="k">def</span> <span class="nf">examples_for_paper</span><span class="p">():</span>
    <span class="n">testwords</span> <span class="o">=</span> <span class="s2">&quot;John Al&#39;Rahem&quot;</span>
    <span class="n">min_string_length_to_scrub_with</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">scrub_string_suffixes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
    <span class="n">max_errors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">at_word_boundaries_only</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">words_regexes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">get_anon_fragments_from_string</span><span class="p">(</span><span class="n">testwords</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">min_string_length_to_scrub_with</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">words_regexes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_string_regex_elements</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="n">scrub_string_suffixes</span><span class="p">,</span>
            <span class="n">at_word_boundaries_only</span><span class="o">=</span><span class="n">at_word_boundaries_only</span><span class="p">,</span>
            <span class="n">max_errors</span><span class="o">=</span><span class="n">max_errors</span>
        <span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- For words </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testwords</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">words_regexes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">testphrase</span> <span class="o">=</span> <span class="s2">&quot;4 Privet Drive&quot;</span>
    <span class="n">phrase_regexes</span> <span class="o">=</span> <span class="n">get_phrase_regex_elements</span><span class="p">(</span>
        <span class="n">testphrase</span><span class="p">,</span>
        <span class="n">max_errors</span><span class="o">=</span><span class="n">max_errors</span><span class="p">,</span>
        <span class="n">at_word_boundaries_only</span><span class="o">=</span><span class="n">at_word_boundaries_only</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- For phrase </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testphrase</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">phrase_regexes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">testnumber</span> <span class="o">=</span> <span class="s2">&quot;(01223) 123456&quot;</span>
    <span class="n">anonymise_numbers_at_word_boundaries_only</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">anonymise_numbers_at_numeric_boundaries_only</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">number_regexes</span> <span class="o">=</span> <span class="n">get_code_regex_elements</span><span class="p">(</span>
        <span class="n">get_digit_string_from_vaguely_numeric_string</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">testnumber</span><span class="p">)),</span>
        <span class="n">at_word_boundaries_only</span><span class="o">=</span><span class="n">anonymise_numbers_at_word_boundaries_only</span><span class="p">,</span>
        <span class="n">at_numeric_boundaries_only</span><span class="o">=</span><span class="n">anonymise_numbers_at_numeric_boundaries_only</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- For number </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testnumber</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">number_regexes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">testcode</span> <span class="o">=</span> <span class="s2">&quot;CB12 3DE&quot;</span>
    <span class="n">anonymise_codes_at_word_boundaries_only</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">code_regexes</span> <span class="o">=</span> <span class="n">get_code_regex_elements</span><span class="p">(</span>
        <span class="n">reduce_to_alphanumeric</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">testcode</span><span class="p">)),</span>
        <span class="n">at_word_boundaries_only</span><span class="o">=</span><span class="n">anonymise_codes_at_word_boundaries_only</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- For code </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testcode</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">code_regexes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">n_digits</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">nonspec_10_digit_number_regexes</span> <span class="o">=</span> <span class="n">get_number_of_length_n_regex_elements</span><span class="p">(</span>
        <span class="n">n_digits</span><span class="p">,</span>
        <span class="n">at_word_boundaries_only</span><span class="o">=</span><span class="n">anonymise_numbers_at_word_boundaries_only</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- NONSPECIFIC: numbers of length </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_digits</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">nonspec_10_digit_number_regexes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">uk_postcode_regexes</span> <span class="o">=</span> <span class="n">get_uk_postcode_regex_elements</span><span class="p">(</span>
        <span class="n">at_word_boundaries_only</span><span class="o">=</span><span class="n">anonymise_codes_at_word_boundaries_only</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- NONSPECIFIC: UK postcodes:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">uk_postcode_regexes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">testdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2016</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
    <span class="n">date_regexes</span> <span class="o">=</span> <span class="n">get_date_regex_elements</span><span class="p">(</span><span class="n">testdate</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- For date </span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testdate</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">date_regexes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">rootlogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">configure_logger_for_colour</span><span class="p">(</span><span class="n">rootlogger</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="c1"># unittest.main()</span>
    <span class="n">examples_for_paper</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_using/index.html">9. Using the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/index.html">15. Automatic documentation of source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>